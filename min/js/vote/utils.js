import{searchBoxElement,cardsContainer,cardsContainerPending,msInSecond,headerContainer,ADDITIONAL_HEADER_MARGIN,cardModes,COLOR_TRANSITION_TIME}from"./constants.js";import{createElement}from"./createElement.js";import state from"./state.js";export{createElement}from"./createElement.js";function debounce(r,a){let o;return(...n)=>new Promise((e,t)=>{clearTimeout(o),o=setTimeout(((e,t,...n)=>{try{e(r(...n))}catch(e){t(e instanceof Error?e:new Error(e))}}).bind(void 0,e,t,...n),a)})}let sendUpvote=debounce(async(t,n)=>{if(state.user?.id){let e=await fetchAPI("vote/addvote",{method:"POST",body:JSON.stringify({featureId:t})});try{e=await e.json()}catch{}!1===e.ok||e.error?Swal.fire({icon:"error",title:"Oops...",text:e.error??e.statusText}):(Swal.fire({icon:"success",title:"Success",text:"Your vote has been successfully recorded."}),n.textContent=Number.parseInt(n.textContent)+1,state.cardsOffset=0,displayCards())}else Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to vote!"})},msInSecond);async function fetchAPI(e,t={},n=5e3){null==t.body||t.headers||(t.headers={"Content-Type":"application/json"});let r=new AbortController;t.signal=r.signal;n=setTimeout(()=>r.abort("Request timed out"),n),e=await fetch(e?"/api/v1/internal/"+e:void 0,t);return clearTimeout(n),e}async function fetchCards(){var e,t,n=new Map((await fetchAPI("vote/list?includePending="+!!state.user?.dev).then(e=>e.json()))?.cards?.sort((e,t)=>!e.pending&&t.pending?1:e.pending&&!t.pending?-1:(t.votes??0)-(e.votes??0)||e.title.localeCompare(t.title)).map(e=>[e.id,e]));state.cardsCache.clear();for([e,t]of n)state.cardsCache.set(e,t)}function updateParams(e,t){var n=new URL(globalThis.location.href),r=new URLSearchParams(globalThis.location.search);t?r.set(e,t):r.delete(e),n.search=r.toString(),globalThis.history.pushState(void 0,void 0,n.toString())}function displayCards(t=searchBoxElement.value,e=26){updateParams("q",t=t.toLowerCase());var n=t?[...state.cardsCache.values()].filter(e=>e.title.toLowerCase().includes(t)||e.body.toLowerCase().includes(t)||e.id.toLowerCase().includes(t)):[...state.cardsCache.values()];if(n.length||cardsContainer.childElementCount||cardsContainerPending.childElementCount){state.cardsOffset||(cardsContainer.innerHTML="",cardsContainerPending.innerHTML="");for(var r of n.slice(state.cardsOffset,e+state.cardsOffset))createCardElement(r);return state.cardsOffset+=e,state.cardsCache.size>state.cardsOffset&&(cardsContainer.childElementCount+cardsContainerPending.childElementCount<e?displayCards(t,e):cardsContainer.clientHeight<window.innerHeight&&displayCards(t,Math.ceil((window.innerHeight-cardsContainer.clientHeight)/(cardsContainer.clientHeight/cardsContainer.childElementCount)))),n}createElement("h2",{textContent:`There are currently no feature requests${t?" matching your search query":""} :(`},cardsContainer,!0)}function createCardElement(t){var e=!!state.user?.dev;let n=createElement("div",{className:"card",id:t.id});var r=createElement("h2",{id:"title",textContent:t.title,contentEditable:e?"plaintext-only":"false"},n),a=t.body||e?createElement("p",{id:"description",textContent:t.body,contentEditable:e?"plaintext-only":"false"},n):void 0,o=createElement("div",{className:"vote-buttons"},n);let s=createElement("span",{className:"vote-counter",textContent:t.pending?"":t.votes??0});t.pending&&e?createElement("button",{textContent:"Approve",className:"vote-button blue-button"},o).addEventListener("click",async()=>{let e=await fetchAPI("vote/approve",{method:"POST",body:JSON.stringify({featureId:t.id})});try{e=await e.json()}catch{}!1===e.ok||e.error?Swal.fire({icon:"error",title:"Oops...",text:e.error??e.statusText}):(Swal.fire({icon:"success",title:"Success",text:"The feature request has been approved."}),cardsContainer.append(n),cardsContainerPending.childElementCount||(document.body.querySelector("#new-requests")?.remove(),document.body.querySelector("#old-requests")?.remove(),document.body.querySelector("#feature-request-overlay + *").style.marginTop=headerContainer.clientHeight+ADDITIONAL_HEADER_MARGIN+"px"))}):t.pending||createElement("button",{className:"vote-button blue-button",textContent:"Upvote"},o).addEventListener("click",()=>sendUpvote(t.id,s)),o.append(s);var i=createElement("button",{title:"Copy card Id",className:"manage-button grey-hover"},o);let d=createElement("i",{className:"far fa-copy fa-xl"},i);i.addEventListener("click",()=>{navigator.clipboard.writeText(t.id),d.classList="fas fa-check fa-xl",setTimeout(()=>d.classList="far fa-copy fa-xl",3*msInSecond)}),e&&(r.addEventListener("keydown",e=>{e.target.parentElement.hasAttribute("modified")?e.target.textContent==t.title&&e.target.parentElement.removeAttribute("modified"):e.target.textContent!=t.title&&e.target.parentElement.setAttribute("modified",""),"Enter"===e.key&&(e.preventDefault(),e.target.nextElementSibling.firstChild.focus())}),a?.addEventListener("input",({target:e})=>{e.parentElement.hasAttribute("modified")?e.textContent==t.body&&e.parentElement.removeAttribute("modified"):e.textContent!=t.body&&e.parentElement.setAttribute("modified","")})),!e&&state.user?.id!=t.id.split("_")[0]||((i=createElement("button",{title:"Delete card",className:"manage-button grey-hover"},o)).addEventListener("click",()=>Swal.fire({icon:"warning",title:"Are you sure?",text:"Are you sure you want to delete that card? This action cannot be undone!",showCancelButton:!0,preConfirm:async()=>{await fetchAPI("vote/delete",{method:"DELETE",body:JSON.stringify({featureId:t.id})}),n.remove(),cardsContainerPending.childElementCount||(document.body.querySelector("#new-requests")?.remove(),document.body.querySelector("#old-requests")?.remove(),document.body.querySelector("#feature-request-overlay + *").style.marginTop=headerContainer.clientHeight+ADDITIONAL_HEADER_MARGIN+"px")}})),createElement("i",{className:"far fa-trash-can fa-xl"},i)),e&&createElement("p",{id:"userId",title:"Click to copy",textContent:t.id.split("_")[0]},o).addEventListener("click",()=>navigator.clipboard.writeText(t.id.split("_")[0])),(t.pending?cardsContainerPending:cardsContainer).append(n),a?.value&&(a.style.height=a.scrollHeight+"px")}function toggleCardDisplayMode(){localStorage.setItem("displayMode",cardsContainer.classList.contains(cardModes.columnMode)?"cardsInRows":"cardsInColumns"),cardsContainer.classList.toggle(cardModes.columnMode),cardsContainerPending.classList.toggle(cardModes.columnMode),cardsContainer.classList.toggle(cardModes.rowMode),cardsContainerPending.classList.toggle(cardModes.rowMode)}let currentTheme;function setColorScheme(e="dark"===currentTheme?"light":"dark"){if(currentTheme!==e){currentTheme=e,localStorage.setItem("theme",currentTheme);for(var t of["bg","text","input-bg","input-focus-bg","card-bg","grey-text"])document.documentElement.style.setProperty(`--${t}-color`,`var(--${currentTheme}-mode-${t}-color)`);if(state.pageIsLoaded){let t=document.querySelectorAll("body, #header-container button, #header-container>#search-box, .card");for(var n of t)n.classList.add("color-transition");setTimeout(()=>{for(var e of t)e.classList.remove("color-transition")},COLOR_TRANSITION_TIME)}}}export{debounce,sendUpvote,fetchAPI,fetchCards,updateParams,displayCards,createCardElement,toggleCardDisplayMode,setColorScheme};