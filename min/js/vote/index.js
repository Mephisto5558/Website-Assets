function a(e,t,n,o=!1){let i=document.createElement(e);if(t)for(let s of Object.keys(t)){let m=t[s];m!==void 0&&(typeof m=="object"&&m!=null&&!Array.isArray(m)&&s in i?Object.assign(i[s],m):i[s]=m)}return n&&(o?n.replaceChildren(i):n.append(i)),i}var P=403,k=200,w=140,M=4e3,H=39,y=16,v=768,D=300,g=1e3,f={columnMode:"cards-column-mode",rowMode:"cards-row-mode"},c=document.body.querySelector("#header-container"),d=document.body.querySelector("#cards-container"),u=document.body.querySelector("#cards-container-pending"),L=document.body.querySelector("#feature-request-overlay"),E=a("input",{type:"text",placeholder:"Search",id:"search-box",value:new URLSearchParams(globalThis.location.search).get("q")??"",className:"grey-hover",maxLength:k});var B={cardsCache:new Map,user:void 0,cardsOffset:0,pageIsLoaded:!1,smallScreen:!1},r=B;function T(e,t){let n;return async(...o)=>new Promise((i,s)=>{clearTimeout(n),n=setTimeout(()=>{try{i(e(...o))}catch(m){s(m instanceof Error?m:new Error(String(m)))}},t)})}var U=T(async(e,t)=>{if(!r.user?.id)return void Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to vote!"});let n=await h("vote/addvote",{method:"POST",body:JSON.stringify({featureId:e})});try{n=await n.json()}catch{}if(n.ok===!1||n.error)return void Swal.fire({icon:"error",title:"Oops...",text:n.error??n.statusText});Swal.fire({icon:"success",title:"Success",text:"Your vote has been successfully recorded."});let o=r.cardsCache.get(e);o.votes=(o.votes??0)+1,t.textContent=o.votes.toLocaleString(),r.cardsOffset=0,p()},g);async function h(e,t={},n=5e3){t.body!=null&&!t.headers&&(t.headers={"Content-Type":"application/json"});let o=new AbortController;t.signal=o.signal;let i=setTimeout(()=>o.abort("Request timed out"),n);return await fetch(`/api/v1/internal/${e}`,t).finally(()=>clearTimeout(i))}async function A(){let e=new Map((await h(`vote/list?includePending=${!!r.user?.dev}`).then(t=>t.json()))?.cards?.toSorted((t,n)=>!t.pending&&n.pending?1:t.pending&&!n.pending?-1:(n.votes??0)-(t.votes??0)||t.title.localeCompare(n.title)).map(t=>[t.id,t]));r.cardsCache.clear();for(let[t,n]of e)r.cardsCache.set(t,n)}function $(e,t){let n=new URL(globalThis.location.href),o=new URLSearchParams(globalThis.location.search);t?o.set(e,t):o.delete(e),n.search=o.toString(),globalThis.history.pushState(void 0,"",n.toString())}function p(e=E.value,t=26){e=e.toLowerCase(),$("q",e);let n=e?[...r.cardsCache.values()].filter(o=>o.title.toLowerCase().includes(e)||o.body?.toLowerCase().includes(e)||o.id.toLowerCase().includes(e)):[...r.cardsCache.values()];if(!n.length&&!d.childElementCount&&!u.childElementCount)return void a("h2",{textContent:`There are currently no feature requests${e?" matching your search query":""} :(`},d,!0);r.cardsOffset||(d.innerHTML="",u.innerHTML="");for(let o of n.slice(r.cardsOffset,t+r.cardsOffset))F(o);return r.cardsOffset+=t,r.cardsCache.size>r.cardsOffset&&(d.childElementCount+u.childElementCount<t?p(e,t):d.clientHeight<window.innerHeight&&p(e,Math.ceil((window.innerHeight-d.clientHeight)/(d.clientHeight/d.childElementCount)))),n}function F(e){let t=!!r.user?.dev,n=a("div",{className:"card",id:e.id}),o=a("h2",{id:"title",textContent:e.title,contentEditable:t?"plaintext-only":"false"},n),i=e.body||t?a("p",{id:"description",textContent:e.body??"",contentEditable:t?"plaintext-only":"false"},n):void 0,s=a("div",{className:"vote-buttons"},n),m=a("span",{className:"vote-counter",textContent:e.pending?"":(e.votes??0).toString()});e.pending&&t?a("button",{textContent:"Approve",className:"vote-button blue-button"},s).addEventListener("click",async()=>{let l=await h("vote/approve",{method:"POST",body:JSON.stringify({featureId:e.id})}).then(S=>S.json()).catch(S=>S);if(l.ok===!1||l.error)return void Swal.fire({icon:"error",title:"Oops...",text:l.error??l.statusText});Swal.fire({icon:"success",title:"Success",text:"The feature request has been approved."}),d.append(n),u.childElementCount||(document.body.querySelector("#new-requests")?.remove(),document.body.querySelector("#old-requests")?.remove(),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${c.clientHeight+y}px`)}):e.pending||a("button",{className:"vote-button blue-button",textContent:"Upvote"},s).addEventListener("click",async()=>U(e.id,m)),s.append(m);let R=a("button",{title:"Copy card Id",className:"manage-button grey-hover"},s),O=a("i",{className:"far fa-copy fa-xl"},R);if(R.addEventListener("click",()=>{navigator.clipboard.writeText(e.id),O.classList="fas fa-check fa-xl",setTimeout(()=>O.classList="far fa-copy fa-xl",g*3)}),t&&(o.addEventListener("keydown",l=>{!(l.target instanceof HTMLElement)||!(l.target.parentElement instanceof HTMLElement)||(l.target.parentElement.hasAttribute("modified")?l.target.textContent==e.title&&l.target.parentElement.removeAttribute("modified"):l.target.textContent!=e.title&&l.target.parentElement.setAttribute("modified",""),l.key==="Enter"&&(l.preventDefault(),l.target.nextElementSibling.firstElementChild.focus()))}),i?.addEventListener("input",l=>{!(l.target instanceof HTMLElement)||!(l.target.parentElement instanceof HTMLElement)||(l.target.parentElement.hasAttribute("modified")?l.target.textContent==e.body&&l.target.parentElement.removeAttribute("modified"):l.target.textContent!=e.body&&l.target.parentElement.setAttribute("modified",""))})),t||r.user?.id==e.id.split("_")[0]){let l=a("button",{title:"Delete card",className:"manage-button grey-hover"},s);l.addEventListener("click",async()=>Swal.fire({icon:"warning",title:"Are you sure?",text:"Are you sure you want to delete that card? This action cannot be undone!",showCancelButton:!0,preConfirm:async()=>{await h("vote/delete",{method:"DELETE",body:JSON.stringify({featureId:e.id})}),n.remove(),u.childElementCount||(document.body.querySelector("#new-requests")?.remove(),document.body.querySelector("#old-requests")?.remove(),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${c.clientHeight+y}px`)}})),a("i",{className:"far fa-trash-can fa-xl"},l)}t&&a("p",{id:"userId",title:"Click to copy",textContent:e.id.split("_")[0]},s).addEventListener("click",async()=>navigator.clipboard.writeText(e.id.split("_")[0])),(e.pending?u:d).append(n),i?.textContent&&(i.style.height=`${i.scrollHeight}px`)}function _(){localStorage.setItem("displayMode",d.classList.contains(f.columnMode)?"cardsInRows":"cardsInColumns"),d.classList.toggle(f.columnMode),u.classList.toggle(f.columnMode),d.classList.toggle(f.rowMode),u.classList.toggle(f.rowMode)}var C;function x(e=C==="dark"?"light":"dark"){if(C!==e){C=e,localStorage.setItem("theme",C);for(let t of["bg","text","input-bg","input-focus-bg","card-bg","grey-text"])document.documentElement.style.setProperty(`--${t}-color`,`var(--${C}-mode-${t}-color)`);if(r.pageIsLoaded){let t=document.querySelectorAll("body, #header-container button, #header-container>#search-box, .card");for(let n of t)n.classList.add("color-transition");setTimeout(()=>{for(let n of t)n.classList.remove("color-transition")},D)}}}function I(e,t){return e.elements.namedItem(t)}E.addEventListener("input",T(e=>{if(!(e.target instanceof HTMLInputElement))return;e.target.value.length>e.target.maxLength&&(e.target.value=e.target.value.slice(0,e.target.maxLength)),r.cardsOffset=0;let t=p(e.target.value);document.querySelector("#feature-request-count > span").textContent=(t?.length??0).toLocaleString()},g/2));c.querySelector("#toggle-cards-display").addEventListener("click",()=>_());c.querySelector("#toggle-color-scheme").addEventListener("click",()=>x());window.addEventListener("scroll",()=>{r.cardsCache.size>r.cardsOffset&&document.documentElement.scrollTop+document.documentElement.clientHeight>=document.documentElement.scrollHeight-y&&p()});var q=window.innerWidth;window.addEventListener("resize",T(()=>{let e=window.innerWidth;q>=v&&e<v||q<v&&e>=v?globalThis.location.reload():q=e},g/2));window.addEventListener("beforeunload",e=>{document.body.querySelectorAll(".card[modified]").length&&e.preventDefault()});var b,N=e=>{!e||e instanceof KeyboardEvent&&e.key!=="Escape"||L.style.display==="none"||(c.removeAttribute("inert"),d.removeAttribute("inert"),u.removeAttribute("inert"),b&&b.removeAttribute("inert"),r.smallScreen&&d.style.removeProperty("display"),L.style.removeProperty("display"))},G=T(async e=>{e.preventDefault();let t=e.target.parentElement;if(!t?.title||!t.description)return;let n=await h("vote/new",{method:"POST",body:JSON.stringify({title:I(t,"title").value.trim(),description:I(t,"description").value.trim()})}).catch(i=>i),o=await(n instanceof Response?n.json().catch(i=>i):n);if(o instanceof Error||"error"in o)return void Swal.fire({icon:"error",title:"Oops...",text:"error"in o?o.error:o.message});await Swal.fire({icon:"success",title:"Success",text:`Your feature request has been submitted and ${o.approved?"approved":"will be reviewed shortly"}.`}),r.cardsCache.set(o.id,o),o.approved&&(r.cardsOffset=0,p()),N(),t.reset()},g),W=T(async()=>{let e=[...document.body.querySelectorAll(".card[modified]")].reduce((o,i)=>{i.removeAttribute("modified");let s=r.cardsCache.get(i.id);return(s?.title&&i.children.title.textContent.trim()!==s.title||s?.body&&i.children.description?.textContent.trim()!==s.body)&&o.push({id:i.id,title:i.children.title.textContent.trim(),body:i.children.description?.textContent.trim()??""}),o},[]);if(!e.length)return void Swal.fire({icon:"error",title:"Oops...",text:"No cards have been modified."});let t=await h("vote/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(o=>o),n=await(t instanceof Response?t.json().catch(o=>o):t);if(n instanceof Error||"error"in n)return void Swal.fire({icon:"error",title:"Oops...",text:"error"in n?n.error:n.message});Swal.fire({icon:"success",title:"Success",text:"The cards have been updated."}),r.cardsOffset=0,await A(),p()},g);async function j(){let e=document.createDocumentFragment(),t=a("div",{id:"profile-container"});if(r.user=await h("user").then(async s=>"json"in s?s.json():void 0).catch(()=>{}),!r.user||r.user.errorCode){if(r.user?.errorCode==P)return a("h2",{textContent:r.user.error},document.body,!0);e.append(E),a("button",{id:"feature-request-button",textContent:r.smallScreen?"New Request":"New Feature Request",className:"grey-hover"},e),a("button",{id:"login-button",textContent:r.smallScreen?"Login":"Login with Discord",className:"blue-button"},t).addEventListener("click",()=>globalThis.location.href=`/auth/discord?redirectUrl=${globalThis.location.href}`),e.append(t),c.append(e);return}let n=a("div",{id:"profile-container-wrapper"},t);t.addEventListener("click",s=>{n.contains(s.target)||(n.style.display=n.style.display==="flex"?"none":"flex")});let o=new Image(H,H);o.addEventListener("load",()=>t.append(o)),o.alt="Profile",o.src=`https://cdn.discordapp.com/avatars/${r.user.id}/${r.user.avatar}.webp?size=64`,a("div",{id:"username",textContent:r.user.displayName},n),a("button",{id:"logout-button",textContent:"Logout",className:"blue-button"},n).addEventListener("click",async()=>{let s=await fetch("/auth/logout");await Swal.fire(s.ok?{icon:"success",title:"Success",text:"You are now logged out."}:{icon:"error",title:"Logout failed",text:s.statusText}),s.ok&&globalThis.location.reload()});let i=a("button",{id:"feature-request-button",textContent:r.smallScreen?"New Request":"New Feature Request",className:"grey-hover"});r.smallScreen?(a("br",e),e.append(t),e.append(E),e.append(i)):(e.append(E),e.append(i),e.append(t)),c.append(e)}function Y(){let e=L.querySelector("#feature-request-modal");e.querySelector("#feature-request-submit-button").addEventListener("click",G),c.querySelector("#feature-request-button").addEventListener("click",async()=>{if(!r.user?.id)return Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to create a feature request!"});c.inert=!0,d.inert=!0,u.inert=!0,b&&(b.inert=!0),L.style.display="block",r.smallScreen&&(d.style.display="none")}),e.querySelector("#feature-request-reset-btn").addEventListener("click",N),document.addEventListener("keydown",N);let t=e.querySelector("#feature-request-description");r.user?.dev&&t.removeAttribute("required");let n=e.querySelector("#title-counter"),o=e.querySelector("#description-counter");e.querySelector("#feature-request-title").addEventListener("input",i=>{n.textContent=`${i.target.value.length}/${w}`,n.classList.toggle("limit-reached",i.target.value.length>=w)}),t.addEventListener("input",i=>{o.textContent=`${i.target.value.length}/${M}`,o.classList.toggle("limit-reached",i.target.value.length>=M)})}async function z(e){if(r.cardsCache.has(e)){for(;!document.getElementById(e)&&r.cardsCache.size>r.cardsOffset;)p(),await new Promise(t=>void setTimeout(t,50));return document.getElementById(e)?.scrollIntoView({behavior:"smooth"})}}document.addEventListener("DOMContentLoaded",async()=>{x(localStorage.getItem("theme")??(globalThis.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark")),r.smallScreen=globalThis.matchMedia("(max-width: 768px)").matches;let e=r.smallScreen&&localStorage.getItem("displayMode")==="cardsInRows";await j(),Y(),await A(),d.classList.add(e?f.rowMode:f.columnMode),u.classList.add(e?f.rowMode:f.columnMode),document.querySelector("#feature-request-count > span").textContent=r.cardsCache.size.toLocaleString(),globalThis.location.hash=="#new"&&c.querySelector("#feature-request-button").click(),navigator.clipboard??={writeText:t=>void Swal.fire({icon:"error",title:"Copying is not available due to this page being served over HTTP.",text:`This was what you tried to copy: ${t}`})},p(),setTimeout(async()=>z(globalThis.location.hash.slice(1)),g/10),r.user?.dev&&(u.childElementCount&&(document.body.insertBefore(a("h2",{id:"new-requests",textContent:"New Requests"}),u),document.body.insertBefore(a("h2",{id:"old-requests",textContent:"Approved Requests"}),d)),b=a("button",{id:"save-button",title:"Save",className:"blue-button"},document.body),a("i",{className:"fas fa-save fa-xl"},b),b.addEventListener("click",W)),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${c.clientHeight+y}px`,document.documentElement.style.scrollPaddingTop=`${c.clientHeight+20}px`,r.pageIsLoaded=!0});export{N as hideFeatureReqElement,G as sendFeatureRequest,W as updateCards};
//# sourceMappingURL=index.js.map
