import{featureRequestOverlay,headerContainer,cardsContainer,cardsContainerPending,msInSecond,searchBoxElement,cardModes,HTTP_STATUS_FORBIDDEN,PROFILE_IMG_SIZE,MAX_TITLE_LENGTH,MAX_BODY_LENGTH,ADDITIONAL_HEADER_MARGIN}from"./constants.js";import{debounce,fetchAPI,fetchCards,createElement,displayCards,setColorScheme}from"./utils.js";import state from"./state.js";import __ from"./events.js";let saveButtonElement,hideFeatureReqElement=(e={})=>{e.key&&"Escape"!==e.key||"none"===featureRequestOverlay.style.display||(headerContainer.removeAttribute("inert"),cardsContainer.removeAttribute("inert"),cardsContainerPending.removeAttribute("inert"),saveButtonElement&&saveButtonElement.removeAttribute("inert"),state.smallScreen&&cardsContainer.style.removeProperty("display"),featureRequestOverlay.style.removeProperty("display"))},sendFeatureRequest=debounce(async e=>{e.preventDefault();e=e.target.parentElement;if(e.title&&e.description){let t=await fetchAPI("vote/new",{method:"POST",body:JSON.stringify({title:e.title.value.trim(),description:e.description.value.trim()})}).catch(e=>t=e),r=await t.json?.().catch(e=>r=e);!t.ok||t.error||r instanceof Error?Swal.fire({icon:"error",title:"Oops...",text:t.error??t.statusText??r?.message}):(await Swal.fire({icon:"success",title:"Success",text:`Your feature request has been submitted and ${r.approved?"approved":"will be reviewed shortly"}.`}),state.cardsCache.set(r.id,r),r.approved&&(state.cardsOffset=0,displayCards()),hideFeatureReqElement(),e.reset())}},msInSecond),updateCards=debounce(async()=>{var t=[...document.body.querySelectorAll(".card[modified]")].reduce((e,t)=>{t.removeAttribute("modified");var r=state.cardsCache.get(t.id);return(r?.title&&t.children.title.textContent.trim()!==r.title||r.body&&t.children.description?.textContent.trim()!==r.body)&&e.push({id:t.id,title:t.children.title.textContent.trim(),body:t.children.description.textContent.trim()}),e},[]);if(t.length){let e=await fetchAPI("vote/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});try{e=await e.json()}catch{}!1===e.ok||e.error?Swal.fire({icon:"error",title:"Oops...",text:e.error??e.statusText}):(Swal.fire({icon:"success",title:"Success",text:"The cards have been updated."}),state.cardsOffset=0,await fetchCards(),displayCards())}else Swal.fire({icon:"error",title:"Oops...",text:"No cards have been modified."})},msInSecond);async function createProfileElement(){var e=document.createDocumentFragment();let t=createElement("div",{id:"profile-container"});if(state.user=await fetchAPI("user").then(e=>e.json()).catch(()=>{}),!state.user||state.user.errorCode)return state.user?.errorCode==HTTP_STATUS_FORBIDDEN?createElement("h2",{textContent:state.user.error},document.body,!0):(e.append(searchBoxElement),createElement("button",{id:"feature-request-button",textContent:state.smallScreen?"New Request":"New Feature Request",className:"grey-hover"},e),createElement("button",{id:"login-button",textContent:state.smallScreen?"Login":"Login with Discord",className:"blue-button"},t).addEventListener("click",()=>globalThis.location.href="/auth/discord?redirectUrl="+globalThis.location.href),e.append(t),headerContainer.append(e));let r=createElement("div",{id:"profile-container-wrapper"},t),a=(t.addEventListener("click",e=>{r.contains(e.target)||(r.style.display="flex"===r.style.display?"none":"flex")}),new Image(PROFILE_IMG_SIZE,PROFILE_IMG_SIZE));a.onload=()=>t.append(a),a.alt="Profile",a.src=`https://cdn.discordapp.com/avatars/${state.user.id}/${state.user.avatar}.webp?size=64`,createElement("div",{id:"username",textContent:state.user.displayName??state.user.username},r),createElement("button",{id:"logout-button",textContent:"Logout",className:"blue-button"},r).addEventListener("click",async()=>{var e=await fetch("/auth/logout");await Swal.fire(e.ok?{icon:"success",title:"Success",text:"You are now logged out."}:{icon:"error",title:"Logout failed",text:e.statusText}),e.ok&&globalThis.location.reload()});var n=createElement("button",{id:"feature-request-button",textContent:state.smallScreen?"New Request":"New Feature Request",className:"grey-hover"});state.smallScreen?(createElement("br",e),e.append(t),e.append(searchBoxElement),e.append(n)):(e.append(searchBoxElement),e.append(n),e.append(t)),headerContainer.append(e)}function createFeatureReqElement(){var e=featureRequestOverlay.querySelector("#feature-request-modal");e.querySelector("#feature-request-submit-button").addEventListener("click",sendFeatureRequest),headerContainer.querySelector("#feature-request-button").addEventListener("click",()=>{if(!state.user?.id)return Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to create a feature request!"});headerContainer.inert=!0,cardsContainer.inert=!0,cardsContainerPending.inert=!0,saveButtonElement&&(saveButtonElement.inert=!0),featureRequestOverlay.style.display="block",state.smallScreen&&(cardsContainer.style.display="none")}),e.querySelector("#feature-request-reset-btn").addEventListener("click",hideFeatureReqElement),document.addEventListener("keydown",hideFeatureReqElement),state.user?.dev&&e.querySelector("#feature-request-description").removeAttribute("required");let t=e.querySelector("#title-counter"),r=e.querySelector("#description-counter");e.querySelector("#feature-request-title").addEventListener("input",e=>{t.textContent=e.target.value.length+"/"+MAX_TITLE_LENGTH,e.target.value.length>=MAX_TITLE_LENGTH?t.classList.add("limit-reached"):t.classList.remove("limit-reached")}),e.querySelector("#feature-request-description").addEventListener("input",e=>{r.textContent=e.target.value.length+"/"+MAX_BODY_LENGTH,e.target.value.length>=MAX_BODY_LENGTH?r.classList.add("limit-reached"):r.classList.remove("limit-reached")})}async function findAndScrollToCard(e){if(state.cardsCache.has(e)){for(;!document.getElementById(e)&&state.cardsCache.size>state.cardsOffset;)displayCards(),await new Promise(e=>setTimeout(e,50));return document.getElementById(e)?.scrollIntoView({behavior:"smooth"})}}document.addEventListener("DOMContentLoaded",async()=>{setColorScheme(localStorage.getItem("theme")??(globalThis.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark")),state.smallScreen=globalThis.matchMedia("(max-width: 768px)").matches;var e=state.smallScreen&&"cardsInRows"===localStorage.getItem("displayMode");await createProfileElement(),createFeatureReqElement(),await fetchCards(),cardsContainer.classList.add(e?cardModes.rowMode:cardModes.columnMode),cardsContainerPending.classList.add(e?cardModes.rowMode:cardModes.columnMode),document.querySelector("#feature-request-count > span").textContent=state.cardsCache.size,"#new"==globalThis.location.hash&&headerContainer.querySelector("#feature-request-button").click(),navigator.clipboard??={writeText:e=>Swal.fire({icon:"error",title:"Copying is not available due to this page being served over HTTP.",text:"This was what you tried to copy: "+e})},displayCards(),setTimeout(()=>findAndScrollToCard(globalThis.location.hash.slice(1)),msInSecond/10),state.user?.dev&&(cardsContainerPending.childElementCount&&(document.body.insertBefore(createElement("h2",{id:"new-requests",textContent:"New Requests"}),cardsContainerPending),document.body.insertBefore(createElement("h2",{id:"old-requests",textContent:"Approved Requests"}),cardsContainer)),saveButtonElement=createElement("button",{id:"save-button",title:"Save",classList:"blue-button"},document.body),createElement("i",{classList:"fas fa-save fa-xl"},saveButtonElement),saveButtonElement.addEventListener("click",updateCards)),document.body.querySelector("#feature-request-overlay + *").style.marginTop=headerContainer.clientHeight+ADDITIONAL_HEADER_MARGIN+"px",document.documentElement.style.scrollPaddingTop=headerContainer.clientHeight+20+"px",state.pageIsLoaded=!0});