"use strict";(()=>{function a(e,t,n,o=!1){let i=document.createElement(e);if(t)for(let l of Object.keys(t)){let c=t[l];c!==void 0&&(typeof c=="object"&&c!=null&&!Array.isArray(c)&&l in i?Object.assign(i[l],c):i[l]=c)}return n&&(o?n.replaceChildren(i):n.append(i)),i}var H=403,O=200,x=140,S=4e3,w=39,b=16;var N=300,h=1e3,E={columnMode:"cards-column-mode",rowMode:"cards-row-mode"},m=document.body.querySelector("#header-container"),d=document.body.querySelector("#cards-container"),u=document.body.querySelector("#cards-container-pending"),v=document.body.querySelector("#feature-request-overlay"),y=a("input",{type:"text",placeholder:"Search",id:"search-box",value:new URLSearchParams(globalThis.location.search).get("q")??"",className:"grey-hover",maxLength:O});var r=class{static cardsCache=new Map;static user;static cardsOffset=0;static pageIsLoaded=!1;static smallScreen=!1};function C(e,t){let n;return(...o)=>new Promise((i,l)=>{clearTimeout(n),n=setTimeout(()=>{try{i(e(...o))}catch(c){l(c instanceof Error?c:new Error(c))}},t)})}var k=C(async(e,t)=>{if(!r.user?.id)return void Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to vote!"});let n=await f("vote/addvote",{method:"POST",body:JSON.stringify({featureId:e})});try{n=await n.json()}catch{}if(n.ok===!1||n.error)return void Swal.fire({icon:"error",title:"Oops...",text:n.error??n.statusText});Swal.fire({icon:"success",title:"Success",text:"Your vote has been successfully recorded."}),t.textContent=Number.parseInt(t.textContent)+1,r.cardsOffset=0,p()},h);async function f(e,t={},n=5e3){t.body!=null&&!t.headers&&(t.headers={"Content-Type":"application/json"}),t.signal??=new AbortController().signal;let o=setTimeout(()=>t.signal.abort("Request timed out"),n),i=await fetch(e?`/api/v1/internal/${e}`:void 0,t);return clearTimeout(o),i}async function M(){let e=new Map((await f(`vote/list?includePending=${!!r.user?.dev}`).then(t=>t.json()))?.cards?.sort((t,n)=>!t.pending&&n.pending?1:t.pending&&!n.pending?-1:(n.votes??0)-(t.votes??0)||t.title.localeCompare(n.title)).map(t=>[t.id,t]));r.cardsCache.clear();for(let[t,n]of e)r.cardsCache.set(t,n)}function P(e,t){let n=new URL(globalThis.location.href),o=new URLSearchParams(globalThis.location.search);t?o.set(e,t):o.delete(e),n.search=o.toString(),globalThis.history.pushState(void 0,"",n.toString())}function p(e=y.value,t=26){e=e.toLowerCase(),P("q",e);let n=e?[...r.cardsCache.values()].filter(o=>o.title.toLowerCase().includes(e)||o.body?.toLowerCase().includes(e)||o.id.toLowerCase().includes(e)):[...r.cardsCache.values()];if(!n.length&&!d.childElementCount&&!u.childElementCount)return void a("h2",{textContent:`There are currently no feature requests${e?" matching your search query":""} :(`},d,!0);r.cardsOffset||(d.innerHTML="",u.innerHTML="");for(let o of n.slice(r.cardsOffset,t+r.cardsOffset))_(o);return r.cardsOffset+=t,r.cardsCache.size>r.cardsOffset&&(d.childElementCount+u.childElementCount<t?p(e,t):d.clientHeight<window.innerHeight&&p(e,Math.ceil((window.innerHeight-d.clientHeight)/(d.clientHeight/d.childElementCount)))),n}function _(e){let t=!!r.user?.dev,n=a("div",{className:"card",id:e.id}),o=a("h2",{id:"title",textContent:e.title,contentEditable:t?"plaintext-only":"false"},n),i=e.body||t?a("p",{id:"description",textContent:e.body??"",contentEditable:t?"plaintext-only":"false"},n):void 0,l=a("div",{className:"vote-buttons"},n),c=a("span",{className:"vote-counter",textContent:e.pending?"":(e.votes??0).toString()});e.pending&&t?a("button",{textContent:"Approve",className:"vote-button blue-button"},l).addEventListener("click",async()=>{let s=await f("vote/approve",{method:"POST",body:JSON.stringify({featureId:e.id})}).then(L=>L.json()).catch(L=>L);if(s.ok===!1||s.error)return void Swal.fire({icon:"error",title:"Oops...",text:s.error??s.statusText});Swal.fire({icon:"success",title:"Success",text:"The feature request has been approved."}),d.append(n),u.childElementCount||(document.body.querySelector("#new-requests")?.remove(),document.body.querySelector("#old-requests")?.remove(),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${m.clientHeight+b}px`)}):e.pending||a("button",{className:"vote-button blue-button",textContent:"Upvote"},l).addEventListener("click",()=>k(e.id,c)),l.append(c);let I=a("button",{title:"Copy card Id",className:"manage-button grey-hover"},l),q=a("i",{className:"far fa-copy fa-xl"},I);if(I.addEventListener("click",()=>{navigator.clipboard.writeText(e.id),q.classList="fas fa-check fa-xl",setTimeout(()=>q.classList="far fa-copy fa-xl",h*3)}),t&&(o.addEventListener("keydown",s=>{!(s.target instanceof HTMLElement)||!(s.target?.parentElement instanceof HTMLElement)||(s.target.parentElement.hasAttribute("modified")?s.target.textContent==e.title&&s.target.parentElement.removeAttribute("modified"):s.target.textContent!=e.title&&s.target.parentElement.setAttribute("modified",""),s.key==="Enter"&&(s.preventDefault(),s.target.nextElementSibling.firstChild.focus()))}),i?.addEventListener("input",({target:s})=>{s.parentElement.hasAttribute("modified")?s.textContent==e.body&&s.parentElement.removeAttribute("modified"):s.textContent!=e.body&&s.parentElement.setAttribute("modified","")})),t||r.user?.id==e.id.split("_")[0]){let s=a("button",{title:"Delete card",className:"manage-button grey-hover"},l);s.addEventListener("click",()=>Swal.fire({icon:"warning",title:"Are you sure?",text:"Are you sure you want to delete that card? This action cannot be undone!",showCancelButton:!0,preConfirm:async()=>{await f("vote/delete",{method:"DELETE",body:JSON.stringify({featureId:e.id})}),n.remove(),u.childElementCount||(document.body.querySelector("#new-requests")?.remove(),document.body.querySelector("#old-requests")?.remove(),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${m.clientHeight+b}px`)}})),a("i",{className:"far fa-trash-can fa-xl"},s)}t&&a("p",{id:"userId",title:"Click to copy",textContent:e.id.split("_")[0]},l).addEventListener("click",()=>navigator.clipboard.writeText(e.id.split("_")[0])),(e.pending?u:d).append(n),i?.value&&(i.style.height=`${i.scrollHeight}px`)}var T;function R(e=T==="dark"?"light":"dark"){if(T!==e){T=e,localStorage.setItem("theme",T);for(let t of["bg","text","input-bg","input-focus-bg","card-bg","grey-text"])document.documentElement.style.setProperty(`--${t}-color`,`var(--${T}-mode-${t}-color)`);if(r.pageIsLoaded){let t=document.querySelectorAll("body, #header-container button, #header-container>#search-box, .card");for(let n of t)n.classList.add("color-transition");setTimeout(()=>{for(let n of t)n.classList.remove("color-transition")},N)}}}var g,A=e=>{!e||e instanceof KeyboardEvent&&e.key!=="Escape"||v.style.display==="none"||(m.removeAttribute("inert"),d.removeAttribute("inert"),u.removeAttribute("inert"),g&&g.removeAttribute("inert"),r.smallScreen&&d.style.removeProperty("display"),v.style.removeProperty("display"))},D=C(async e=>{e.preventDefault();let t=e.target.parentElement;if(!t||!t.title||!t.description)return;let n=await f("vote/new",{method:"POST",body:JSON.stringify({title:t.title.value.trim(),description:t.description.value.trim()})}).catch(i=>i),o=await(n instanceof Response?n.json().catch(i=>i):void 0);if(!o||o instanceof Error||n instanceof Error||!n.ok||"error"in n||"error"in o)return void Swal.fire({icon:"error",title:"Oops...",text:n.error??n.statusText??o?.message});await Swal.fire({icon:"success",title:"Success",text:`Your feature request has been submitted and ${o.approved?"approved":"will be reviewed shortly"}.`}),r.cardsCache.set(o.id,o),o.approved&&(r.cardsOffset=0,p()),A(),t.reset()},h),B=C(async()=>{let e=[...document.body.querySelectorAll(".card[modified]")].reduce((n,o)=>{o.removeAttribute("modified");let i=r.cardsCache.get(o.id);return(i?.title&&o.children.title.textContent.trim()!==i.title||i?.body&&o.children.description?.textContent.trim()!==i.body)&&n.push({id:o.id,title:o.children.title.textContent.trim(),body:o.children.description.textContent.trim()}),n},[]);if(!e.length)return void Swal.fire({icon:"error",title:"Oops...",text:"No cards have been modified."});let t=await f("vote/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(n=>n.json?.()).catch(()=>{});if(t.ok===!1||t.error)return void Swal.fire({icon:"error",title:"Oops...",text:t.error??t.statusText});Swal.fire({icon:"success",title:"Success",text:"The cards have been updated."}),r.cardsOffset=0,await M(),p()},h);async function $(){let e=document.createDocumentFragment(),t=a("div",{id:"profile-container"});if(r.user=await f("user").then(l=>l.json()).catch(()=>{}),!r.user||r.user.errorCode)return r.user?.errorCode==H?a("h2",{textContent:r.user.error},document.body,!0):(e.append(y),a("button",{id:"feature-request-button",textContent:r.smallScreen?"New Request":"New Feature Request",className:"grey-hover"},e),a("button",{id:"login-button",textContent:r.smallScreen?"Login":"Login with Discord",className:"blue-button"},t).addEventListener("click",()=>globalThis.location.href=`/auth/discord?redirectUrl=${globalThis.location.href}`),e.append(t),void m.append(e));let n=a("div",{id:"profile-container-wrapper"},t);t.addEventListener("click",l=>{n.contains(l.target)||(n.style.display=n.style.display==="flex"?"none":"flex")});let o=new Image(w,w);o.onload=()=>t.append(o),o.alt="Profile",o.src=`https://cdn.discordapp.com/avatars/${r.user.id}/${r.user.avatar}.webp?size=64`,a("div",{id:"username",textContent:r.user.displayName??r.user.username},n),a("button",{id:"logout-button",textContent:"Logout",className:"blue-button"},n).addEventListener("click",async()=>{let l=await fetch("/auth/logout");await Swal.fire(l.ok?{icon:"success",title:"Success",text:"You are now logged out."}:{icon:"error",title:"Logout failed",text:l.statusText}),l.ok&&globalThis.location.reload()});let i=a("button",{id:"feature-request-button",textContent:r.smallScreen?"New Request":"New Feature Request",className:"grey-hover"});r.smallScreen?(a("br",e),e.append(t),e.append(y),e.append(i)):(e.append(y),e.append(i),e.append(t)),m.append(e)}function U(){let e=v.querySelector("#feature-request-modal");e.querySelector("#feature-request-submit-button").addEventListener("click",D),m.querySelector("#feature-request-button").addEventListener("click",()=>{if(!r.user?.id)return Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to create a feature request!"});m.inert=!0,d.inert=!0,u.inert=!0,g&&(g.inert=!0),v.style.display="block",r.smallScreen&&(d.style.display="none")}),e.querySelector("#feature-request-reset-btn").addEventListener("click",A),document.addEventListener("keydown",A);let t=e.querySelector("#feature-request-description");r.user?.dev&&t.removeAttribute("required");let n=e.querySelector("#title-counter"),o=e.querySelector("#description-counter");e.querySelector("#feature-request-title").addEventListener("input",i=>{n.textContent=`${i.target.value.length}/${x}`,i.target.value.length>=x?n.classList.add("limit-reached"):n.classList.remove("limit-reached")}),t.addEventListener("input",i=>{o.textContent=`${i.target.value.length}/${S}`,i.target.value.length>=S?o.classList.add("limit-reached"):o.classList.remove("limit-reached")})}async function G(e){if(r.cardsCache.has(e)){for(;!document.getElementById(e)&&r.cardsCache.size>r.cardsOffset;)p(),await new Promise(t=>setTimeout(t,50));return document.getElementById(e)?.scrollIntoView({behavior:"smooth"})}}document.addEventListener("DOMContentLoaded",async()=>{R(localStorage.getItem("theme")??(globalThis.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark")),r.smallScreen=globalThis.matchMedia("(max-width: 768px)").matches;let e=r.smallScreen&&localStorage.getItem("displayMode")==="cardsInRows";await $(),U(),await M(),d.classList.add(e?E.rowMode:E.columnMode),u.classList.add(e?E.rowMode:E.columnMode),document.querySelector("#feature-request-count > span").textContent=r.cardsCache.size.toLocaleString(),globalThis.location.hash=="#new"&&m.querySelector("#feature-request-button").click(),navigator.clipboard??={writeText:t=>Swal.fire({icon:"error",title:"Copying is not available due to this page being served over HTTP.",text:`This was what you tried to copy: ${t}`})},p(),setTimeout(()=>G(globalThis.location.hash.slice(1)),h/10),r.user?.dev&&(u.childElementCount&&(document.body.insertBefore(a("h2",{id:"new-requests",textContent:"New Requests"}),u),document.body.insertBefore(a("h2",{id:"old-requests",textContent:"Approved Requests"}),d)),g=a("button",{id:"save-button",title:"Save",className:"blue-button"},document.body),a("i",{className:"fas fa-save fa-xl"},g),g.addEventListener("click",B)),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${m.clientHeight+b}px`,document.documentElement.style.scrollPaddingTop=`${m.clientHeight+20}px`,r.pageIsLoaded=!0});})();
//# sourceMappingURL=index.js.map
