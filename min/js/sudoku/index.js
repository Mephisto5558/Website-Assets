import{bgColorSwitcher,DEFAULT_BOARD_SIZE,fgColorSwitcher,htmlBoard,loadingContainer,MS_IN_SEC,numberOverviewSpans,regenerateBtn,REPORT_PROD_WORKER_URL,shareBtn,solutionBtn}from"./constants.js";import{createHTMLBoard,createHTMLOverviewSpans,displayBoard,getNumberAmounts}from"./generateSudoku.js";import{generateShareURL,loadFromShareURL}from"./shareSudoku.js";import{setRootStyle,getRootStyle,invertHex,saveToClipboard,initializeColorPicker,clearTimer,checkErrors,updateMinMax}from"./utils.js";import __ from"./events.js";document.documentElement.removeAttribute("style"),initializeColorPicker(bgColorSwitcher,"sudoku-bg-color",e=>setRootStyle("--background-color",e)),initializeColorPicker(fgColorSwitcher,"sudoku-fg-color",e=>{setRootStyle("--foreground-color",e),setRootStyle("--foreground-color-inverted",invertHex(e))}),setRootStyle("--foreground-color-secondary-inverted",invertHex(getRootStyle("--foreground-color-secondary")));let shareEventListener,solutionEventListener;function updateBtnListeners(o,r){let t=!1;shareBtn.removeEventListener("click",shareEventListener),solutionBtn.removeEventListener("click",solutionEventListener),shareEventListener=async()=>{var e=globalThis.location.search?globalThis.location.href:generateShareURL(o,r);e!=globalThis.location.href&&globalThis.history.pushState({},"",e),await saveToClipboard(e)},solutionEventListener=e=>{if(t=!t)return console.debug("Showing solution."),displayBoard(r,htmlBoard,numberOverviewSpans,!0),e.target.textContent="Hide Solution";console.debug("Hiding solution."),displayBoard(o,htmlBoard,numberOverviewSpans,!1),e.target.textContent="Show Solution"},shareBtn.addEventListener("click",shareEventListener),solutionBtn.addEventListener("click",solutionEventListener)}async function createCrossDomainWorker(e){e=await fetch(e).then(e=>e.text()),e=URL.createObjectURL(new Blob([e],{type:"application/javascript"}));return new Worker(e)}let resolveFunction;async function createSudokuWorker(){var e=await createCrossDomainWorker(globalThis.debug?"./sudoku.worker.js":REPORT_PROD_WORKER_URL);return e.addEventListener("message",e=>{if("result"==e.data.type)return console.log("UI: Received result from worker."),resolveFunction?.(e.data.payload),resolveFunction=void 0;(console["progress"==e.data.type?"debug":e.data.type]??console.log)("Worker: "+e.data.message),"progress"==e.data.type&&(loadingContainer.children.namedItem("loading-status").textContent=e.data.message)}),e.addEventListener("error",e=>console.error("Worker:",e)),e}let sudokuWorker,showedLoading=!1,isGenerating=!1;async function regenerate(e,o){if(!isGenerating){isGenerating=!0,e&&(e.target.disabled=!0),o||((o=new URL(globalThis.location.href)).search="",globalThis.history.pushState({},"",o));o=setTimeout(()=>{showedLoading=!0,loadingContainer.classList.remove("hiding"),loadingContainer.style.removeProperty("display")},MS_IN_SEC/10);try{clearTimer();var n=performance.now();let{size:o,minHoles:e,maxHoles:r,holes:t}=updateMinMax();globalThis.debugBoard?console.debug("Using debug board."):console.log(`Size: ${o}, Holes: ${t}/${r} (min: ${e})`),sudokuWorker??=await createSudokuWorker();var{fullBoard:a,board:i}=loadFromShareURL()??await new Promise(e=>{resolveFunction=e,console.log("UI: Posting task to worker..."),sudokuWorker.postMessage({size:o,holes:t,debugBoard:globalThis.debugBoard})});globalThis.fullBoardNumberAmt=getNumberAmounts(a),setRootStyle("--sudoku-row-count",i.length),a.length!=htmlBoard.length&&(createHTMLBoard(globalThis.debugBoard?DEFAULT_BOARD_SIZE:a.length),htmlBoard.length=0,htmlBoard.push(...[...document.querySelectorAll("#sudoku > tbody > tr")].map(e=>[...e.children].map(e=>e.firstChild))),createHTMLOverviewSpans(globalThis.debugBoard?DEFAULT_BOARD_SIZE:a.length),numberOverviewSpans.length=0,numberOverviewSpans.push(...document.querySelectorAll("#number-overview > tbody > tr > td > span"))),displayBoard(i,htmlBoard,numberOverviewSpans),checkErrors(htmlBoard),console.debug(`Took ${performance.now()-n}ms to generate and render.`),updateBtnListeners(i,a)}finally{clearTimeout(o),showedLoading?(loadingContainer.classList.add("hiding"),loadingContainer.addEventListener("animationend",()=>loadingContainer.style.display="none",{once:!0})):loadingContainer.style.display="none"}isGenerating=!1,e&&(e.target.disabled=!1)}}regenerateBtn.addEventListener("click",regenerate),regenerate(void 0,!0);