import{displayBoard,generateSudoku,getNumberAmounts}from"./generateSudoku.js";globalThis.debug=!1,globalThis.debugBoard=!0;let DEFAULT_BOARD_SIZE=9,MS_IN_SEC=1e3,SEC_IN_MIN=60,MIN_HOLES=Math.floor(DEFAULT_BOARD_SIZE**2*.2),MAX_HOLES=Math.ceil(DEFAULT_BOARD_SIZE**2*.9),sudoku=(document.documentElement.removeAttribute("style"),globalThis.htmlBoard=[...document.querySelectorAll("#sudoku > tbody > tr")].map(e=>[...e.children].map(e=>e.firstChild)),document.querySelector("#sudoku")),timerSpan=document.querySelector("#timer"),loadingContainer=document.querySelector("#loading-container"),regenerateBtn=document.querySelector("#regenerate-btn"),numberOverviewSpans=[...document.querySelectorAll("#number-overview > tbody > tr > td > span")];function invertHex(e){return"#"+(3==(e=e.replace("#","")).length?[...e]:e.match(/\w{2}/g)).map(e=>(255-Number.parseInt(e,16)).toString(16).padStart(2,"0")).join("")}function checkErrors(){var e,t,r=globalThis.htmlBoard.flat().reduce((r,o)=>{for(let e=0,t=["group","col","row"];e<t.length;e++){var a=Number(o.dataset[t[e]])-1;r[e][a]??=[],r[e][a].type=t[e],r[e][a].push(o.parentElement)}return r},[[],[],[]]).flat(),o=new Set;for(e of r){var a=[...document.querySelectorAll(`#sudoku > tbody > tr > td > input[data-${e.type}='${e[0].firstChild.dataset[e.type]}']`)],l=a.map(e=>Number(e.value)).filter(Boolean);if(l.length>new Set(l).size)for(var n of a)o.add(JSON.stringify(n.dataset))}for(t of globalThis.htmlBoard.flat())o.has(JSON.stringify(t.dataset))?t.parentElement.classList.add("error"):t.parentElement.classList.remove("error")}function startTimer(){let t=performance.now();globalThis.timerInterval=setInterval(()=>{var e=(performance.now()-t)/MS_IN_SEC;timerSpan.textContent=String(Math.floor(e/SEC_IN_MIN)).padStart(2,"0")+":"+String(Math.round(e%SEC_IN_MIN)).padStart(2,"0")},MS_IN_SEC)}function clearTimer(){globalThis.timerInterval=clearInterval(globalThis.timerInterval),timerSpan.textContent="00:00"}function updateNumberOverviewSpan(e,t=!0){var r=numberOverviewSpans[e-1];r.textContent=Number(r.textContent)+(t?1:-1),globalThis.fullBoardNumberAmt.get(e)==r.textContent?r.classList.add("complete"):r.classList.remove("complete"),numberOverviewSpans.some(e=>!e.classList.contains("complete"))||(globalThis.timerInterval=clearInterval(globalThis.timerInterval))}sudoku.addEventListener("keypress",e=>e.key!=e.target.value&&(" "==e.key&&(updateNumberOverviewSpan(Number(e.target.value),!1),e.target.value="",checkErrors()),/[1-9]/.test(e.key))?(globalThis.timerInterval||startTimer(),e.preventDefault(),e.target.value&&updateNumberOverviewSpan(Number(e.target.value),!1),e.target.value=e.key,updateNumberOverviewSpan(Number(e.target.value),!0),void checkErrors()):e.preventDefault());let bgColorSwitcher=document.querySelector("#bg-color-switch"),fgColorSwitcher=(bgColorSwitcher.setAttribute("value",globalThis.getComputedStyle(document.documentElement).getPropertyValue("--background-color")),bgColorSwitcher.addEventListener("change",e=>{document.documentElement.style.setProperty("--background-color",e.target.value)}),document.querySelector("#fg-color-switch")),eventKeys=(fgColorSwitcher.setAttribute("value",globalThis.getComputedStyle(document.documentElement).getPropertyValue("--foreground-color")),fgColorSwitcher.addEventListener("change",e=>{document.documentElement.style.setProperty("--foreground-color",e.target.value),document.documentElement.style.setProperty("--foreground-color-inverted",invertHex(e.target.value))}),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab"]);sudoku.addEventListener("keydown",t=>{if("Backspace"==t.key)return updateNumberOverviewSpan(Number(t.target.value),!1),t.target.value="",checkErrors(),t.preventDefault();if(eventKeys.includes(t.key)){t.preventDefault();var r=globalThis.htmlBoard.length-1;let e;for(;(!e||e.disabled)&&(!e||e.dataset.row!=t.target.dataset.row||e.dataset.col!=t.target.dataset.col);){var o=Number((e??t.target).dataset.row)-1,a=Number((e??t.target).dataset.col)-1;switch(t.key){case eventKeys[0]:e=globalThis.htmlBoard[0==o?r:o-1][a];break;case eventKeys[1]:e=globalThis.htmlBoard[o==r?0:1+o][a];break;case eventKeys[2]:e=globalThis.htmlBoard[o][0==a?r:a-1];break;case eventKeys[3]:e=globalThis.htmlBoard[o][a==r?0:1+a];break;case eventKeys[4]:t.shiftKey?e=0==o&&0==a?globalThis.htmlBoard[r][r]:0<a?globalThis.htmlBoard[o][a-1]:globalThis.htmlBoard[o-1][r]:e=o==r&&a==r?globalThis.htmlBoard[0][0]:o==r?globalThis.htmlBoard[o][1+a]:globalThis.htmlBoard[1+o][a]}}e.focus()}}),regenerateBtn.addEventListener("click",async e=>{e.target.disabled=!0,sudoku.parentElement.style.setProperty("visibility","hidden"),loadingContainer.style.removeProperty("display"),clearTimer();var t=performance.now(),r=rando(MIN_HOLES,MAX_HOLES),{fullBoard:r,board:o}=(globalThis.debug&&globalThis.debugBoard?console.debug("Using debug board."):console.log(`Size: ${DEFAULT_BOARD_SIZE}, Holes: ${r}/${MAX_HOLES} (min: ${MIN_HOLES})`),await generateSudoku(DEFAULT_BOARD_SIZE,r));globalThis.fullBoardNumberAmt=getNumberAmounts(r),displayBoard(o),checkErrors(),console.debug(`Took ${performance.now()-t}ms to generate and render.`),document.documentElement.style.setProperty("--sudoku-row-count",o.length),globalThis.screen.availWidth<1.2*Number.parseFloat(getComputedStyle(sudoku).width)&&document.documentElement.style.setProperty("font-size","unset"),loadingContainer.style.setProperty("display","none"),sudoku.parentElement.style.removeProperty("visibility"),e.target.disabled=!1}),regenerateBtn.click();