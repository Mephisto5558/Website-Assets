import{displayBoard,generateSudoku,getNumberAmounts}from"./generateSudoku.js";import{generateShareURL,loadFromShareURL}from"./shareSudoku.js";import{setRootStyle,getRootStyle,invertHex,saveToClipboard,initializeColorPicker}from"./utils.js";document.documentElement.removeAttribute("style"),globalThis.debug=!1,globalThis.debugBoard=!0;let DEFAULT_BOARD_SIZE=9,MS_IN_SEC=1e3,SEC_IN_MIN=60,MIN_HOLES_PERCENTAGE=.2,MAX_HOLES_PERCENTAGE=.75,MIN_HOLES=Math.floor(DEFAULT_BOARD_SIZE**2*MIN_HOLES_PERCENTAGE),MAX_HOLES=Math.ceil(DEFAULT_BOARD_SIZE**2*MAX_HOLES_PERCENTAGE),htmlBoard=[...document.querySelectorAll("#sudoku > tbody > tr")].map(e=>[...e.children].map(e=>e.firstChild)),sudoku=document.querySelector("#sudoku"),timerSpan=document.querySelector("#timer"),loadingContainer=document.querySelector("#loading-container"),loadingContainerSiblings=[...loadingContainer.parentElement.children].filter(e=>e!=loadingContainer),regenerateBtn=document.querySelector("#regenerate-btn"),numberOverviewSpans=[...document.querySelectorAll("#number-overview > tbody > tr > td > span")],shareButton=document.querySelector("#share-btn"),difficultySlider=document.querySelector("#difficulty-slider"),difficultyOutput=document.querySelector("#difficulty-slider + output"),bgColorSwitcher=document.querySelector("#bg-color-switch"),fgColorSwitcher=document.querySelector("#fg-color-switch");function checkErrors(){let l=new Set;var e=e=>{var t,r=new Map;for(t of e){var o=Number(t.value);o&&(r.has(o)||r.set(o,[]),r.get(o).push(t))}if([...r.values()].some(e=>1<e.length))for(var a of e)l.add(a.dataset.row+"-"+a.dataset.col)};for(let t=0;t<htmlBoard.length;t++)e(htmlBoard[t]),e(htmlBoard.map(e=>e[t]));var t,a=Math.sqrt(htmlBoard.length);for(let o=0;o<a;o++)for(let r=0;r<a;r++){var n=[];for(let t=0;t<a;t++)for(let e=0;e<a;e++)n.push(htmlBoard[o*a+t][r*a+e]);e(n)}for(t of htmlBoard.flat())t.parentElement.classList[l.has(t.dataset.row+"-"+t.dataset.col)?"add":"remove"]("error")}function startTimer(){let t=performance.now();globalThis.timerInterval=setInterval(()=>{var e=(performance.now()-t)/MS_IN_SEC;timerSpan.textContent=String(Math.floor(e/SEC_IN_MIN)).padStart(2,"0")+":"+String(Math.round(e%SEC_IN_MIN)).padStart(2,"0")},MS_IN_SEC)}function clearTimer(){globalThis.timerInterval=clearInterval(globalThis.timerInterval),timerSpan.textContent="00:00"}function updateNumberOverviewSpan(e,t=!0){var r=numberOverviewSpans[e-1];r.textContent=Number(r.textContent)+(t?1:-1),globalThis.fullBoardNumberAmt.get(e)==r.textContent?r.classList.add("complete"):r.classList.remove("complete"),numberOverviewSpans.some(e=>!e.classList.contains("complete"))||(globalThis.timerInterval=clearInterval(globalThis.timerInterval))}difficultySlider.addEventListener("input",e=>difficultyOutput.textContent=e.target.value),difficultySlider.min=MIN_HOLES,difficultySlider.max=MAX_HOLES,initializeColorPicker(bgColorSwitcher,"sudoku-bg-color",e=>setRootStyle("--background-color",e)),initializeColorPicker(fgColorSwitcher,"sudoku-fg-color",e=>{setRootStyle("--foreground-color",e),setRootStyle("--foreground-color-inverted",invertHex(e))}),setRootStyle("--foreground-color-secondary-inverted",invertHex(getRootStyle("--foreground-color-secondary"))),sudoku.addEventListener("keypress",e=>e.key!=e.target.value&&(" "==e.key&&(updateNumberOverviewSpan(Number(e.target.value),!1),e.target.value="",checkErrors()),/[1-9]/.test(e.key))?(globalThis.timerInterval||startTimer(),e.preventDefault(),e.target.value&&updateNumberOverviewSpan(Number(e.target.value),!1),e.target.value=e.key,updateNumberOverviewSpan(Number(e.target.value),!0),void checkErrors()):e.preventDefault());let eventKeys=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Home","End"];sudoku.addEventListener("keydown",r=>{if("Backspace"==r.key)return updateNumberOverviewSpan(Number(r.target.value),!1),r.target.value="",checkErrors(),r.preventDefault();if(eventKeys.includes(r.key)){r.preventDefault();var t=htmlBoard.length-1;let e;if(r.key==eventKeys[5]||r.key==eventKeys[6]){var o=r.key==eventKeys[5]?"find":"findLast";let t=e=>!(e.disabled||r.shiftKey&&e.dataset.group!=r.target.dataset.group);e=(r.ctrlKey?htmlBoard[o](e=>e.some(t)):htmlBoard[Number(r.target.dataset.row)-1])[o](t)}for(;(!e||e.disabled)&&(!e||e.dataset.row!=r.target.dataset.row||e.dataset.col!=r.target.dataset.col);){var a=Number((e??r.target).dataset.row)-1,l=Number((e??r.target).dataset.col)-1;switch(r.key){case eventKeys[0]:e=htmlBoard[0==a?t:a-1][l];break;case eventKeys[1]:e=htmlBoard[a==t?0:1+a][l];break;case eventKeys[2]:e=htmlBoard[a][0==l?t:l-1];break;case eventKeys[3]:e=htmlBoard[a][l==t?0:1+l];break;case eventKeys[4]:r.shiftKey?e=0==a&&0==l?htmlBoard[t][t]:0==l?htmlBoard[a-1][t]:htmlBoard[a][l-1]:e=a==t&&l==t?htmlBoard[0][0]:l==t?htmlBoard[1+a][0]:htmlBoard[a][1+l]}}e.focus()}});let shareEventListener;async function regenerate(e,t){var r;e&&(e.target.disabled=!0),t||((t=new URL(globalThis.location.href)).search="",globalThis.history.pushState({},"",t));for(r of loadingContainerSiblings)r.style.setProperty("visibility","hidden");loadingContainer.style.removeProperty("display"),clearTimer();var o,t=performance.now(),a=Number(difficultySlider.value)||rando(MIN_HOLES,MAX_HOLES);difficultySlider.value=a,difficultySlider.parentElement.querySelector("output").textContent=a,globalThis.debug&&globalThis.debugBoard?console.debug("Using debug board."):console.log(`Size: ${DEFAULT_BOARD_SIZE}, Holes: ${a}/${MAX_HOLES} (min: ${MIN_HOLES})`);let{fullBoard:l,board:n}=loadFromShareURL()??await generateSudoku(DEFAULT_BOARD_SIZE,a);globalThis.fullBoardNumberAmt=getNumberAmounts(l),displayBoard(n,htmlBoard,numberOverviewSpans),checkErrors(),console.debug(`Took ${performance.now()-t}ms to generate and render.`),setRootStyle("--sudoku-row-count",n.length),globalThis.screen.availWidth<1.2*Number.parseFloat(getComputedStyle(sudoku).width)&&setRootStyle("font-size","unset"),shareButton.removeEventListener("click",shareEventListener),shareEventListener=async()=>{var e=globalThis.location.search?globalThis.location.href:generateShareURL(n,l);e!=globalThis.location.href&&globalThis.history.pushState({},"",e),await saveToClipboard(e)},shareButton.addEventListener("click",shareEventListener),loadingContainer.style.setProperty("display","none");for(o of loadingContainerSiblings)o.style.removeProperty("visibility");e&&(e.target.disabled=!1)}regenerateBtn.addEventListener("click",regenerate),regenerate(void 0,!0);