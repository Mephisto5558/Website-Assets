import{displayBoard,generateSudoku,getNumberAmounts}from"./generateSudoku.js";import{generateShareURL,loadFromShareURL}from"./shareSudoku.js";globalThis.debug=!1,globalThis.debugBoard=!0;let DEFAULT_BOARD_SIZE=9,MS_IN_SEC=1e3,SEC_IN_MIN=60,MIN_HOLES_PERCENTAGE=.2,MAX_HOLES_PERCENTAGE=.75,MIN_HOLES=Math.floor(DEFAULT_BOARD_SIZE**2*MIN_HOLES_PERCENTAGE),MAX_HOLES=Math.ceil(DEFAULT_BOARD_SIZE**2*MAX_HOLES_PERCENTAGE),sudoku=(document.documentElement.removeAttribute("style"),globalThis.htmlBoard=[...document.querySelectorAll("#sudoku > tbody > tr")].map(e=>[...e.children].map(e=>e.firstChild)),document.querySelector("#sudoku")),timerSpan=document.querySelector("#timer"),loadingContainer=document.querySelector("#loading-container"),loadingContainerSiblings=[...loadingContainer.parentElement.children].filter(e=>e!=loadingContainer),regenerateBtn=document.querySelector("#regenerate-btn"),numberOverviewSpans=[...document.querySelectorAll("#number-overview > tbody > tr > td > span")],shareButton=document.querySelector("#share-btn"),difficultySlider=document.querySelector("#difficulty-slider"),difficultyOutput=document.querySelector("#difficulty-slider + output");function invertHex(e){return"#"+(3==(e=e.replace("#","")).length?[...e]:e.match(/\w{2}/g)).map(e=>(255-Number.parseInt(e,16)).toString(16).padStart(2,"0")).join("")}function checkErrors(){var e,t,r=globalThis.htmlBoard.flat().reduce((r,o)=>{for(let e=0,t=["group","col","row"];e<t.length;e++){var a=Number(o.dataset[t[e]])-1;r[e][a]??=[],r[e][a].type=t[e],r[e][a].push(o.parentElement)}return r},[[],[],[]]).flat(),o=new Set;for(e of r){var a=[...document.querySelectorAll(`#sudoku > tbody > tr > td > input[data-${e.type}='${e[0].firstChild.dataset[e.type]}']`)],l=a.map(e=>Number(e.value)).filter(Boolean);if(l.length>new Set(l).size)for(var n of a)o.add(JSON.stringify(n.dataset))}for(t of globalThis.htmlBoard.flat())o.has(JSON.stringify(t.dataset))?t.parentElement.classList.add("error"):t.parentElement.classList.remove("error")}function startTimer(){let t=performance.now();globalThis.timerInterval=setInterval(()=>{var e=(performance.now()-t)/MS_IN_SEC;timerSpan.textContent=String(Math.floor(e/SEC_IN_MIN)).padStart(2,"0")+":"+String(Math.round(e%SEC_IN_MIN)).padStart(2,"0")},MS_IN_SEC)}function clearTimer(){globalThis.timerInterval=clearInterval(globalThis.timerInterval),timerSpan.textContent="00:00"}function updateNumberOverviewSpan(e,t=!0){var r=numberOverviewSpans[e-1];r.textContent=Number(r.textContent)+(t?1:-1),globalThis.fullBoardNumberAmt.get(e)==r.textContent?r.classList.add("complete"):r.classList.remove("complete"),numberOverviewSpans.some(e=>!e.classList.contains("complete"))||(globalThis.timerInterval=clearInterval(globalThis.timerInterval))}difficultySlider.addEventListener("input",e=>difficultyOutput.textContent=e.target.value),difficultySlider.min=MIN_HOLES,difficultySlider.max=MAX_HOLES;let bgColorSwitcher=document.querySelector("#bg-color-switch"),fgColorSwitcher=(bgColorSwitcher.setAttribute("value",globalThis.getComputedStyle(document.documentElement).getPropertyValue("--background-color")),bgColorSwitcher.addEventListener("change",e=>{document.documentElement.style.setProperty("--background-color",e.target.value)}),document.querySelector("#fg-color-switch")),eventKeys=(fgColorSwitcher.setAttribute("value",globalThis.getComputedStyle(document.documentElement).getPropertyValue("--foreground-color")),fgColorSwitcher.addEventListener("change",e=>{document.documentElement.style.setProperty("--foreground-color",e.target.value),document.documentElement.style.setProperty("--foreground-color-inverted",invertHex(e.target.value))}),document.documentElement.style.setProperty("--foreground-color-secondary-inverted",invertHex(globalThis.getComputedStyle(document.documentElement).getPropertyValue("--foreground-color-secondary"))),sudoku.addEventListener("keypress",e=>e.key!=e.target.value&&(" "==e.key&&(updateNumberOverviewSpan(Number(e.target.value),!1),e.target.value="",checkErrors()),/[1-9]/.test(e.key))?(globalThis.timerInterval||startTimer(),e.preventDefault(),e.target.value&&updateNumberOverviewSpan(Number(e.target.value),!1),e.target.value=e.key,updateNumberOverviewSpan(Number(e.target.value),!0),void checkErrors()):e.preventDefault()),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Home","End"]);sudoku.addEventListener("keydown",r=>{if("Backspace"==r.key)return updateNumberOverviewSpan(Number(r.target.value),!1),r.target.value="",checkErrors(),r.preventDefault();if(eventKeys.includes(r.key)){r.preventDefault();var t=globalThis.htmlBoard.length-1;let e;if(r.key==eventKeys[5]||r.key==eventKeys[6]){var o=r.key==eventKeys[5]?"find":"findLast";let t=e=>!(e.disabled||r.shiftKey&&e.dataset.group!=r.target.dataset.group);e=(r.ctrlKey?globalThis.htmlBoard[o](e=>e.some(t)):globalThis.htmlBoard[Number(r.target.dataset.row)-1])[o](t)}for(;(!e||e.disabled)&&(!e||e.dataset.row!=r.target.dataset.row||e.dataset.col!=r.target.dataset.col);){var a=Number((e??r.target).dataset.row)-1,l=Number((e??r.target).dataset.col)-1;switch(r.key){case eventKeys[0]:e=globalThis.htmlBoard[0==a?t:a-1][l];break;case eventKeys[1]:e=globalThis.htmlBoard[a==t?0:1+a][l];break;case eventKeys[2]:e=globalThis.htmlBoard[a][0==l?t:l-1];break;case eventKeys[3]:e=globalThis.htmlBoard[a][l==t?0:1+l];break;case eventKeys[4]:r.shiftKey?e=0==a&&0==l?globalThis.htmlBoard[t][t]:0<l?globalThis.htmlBoard[a][l-1]:globalThis.htmlBoard[a-1][t]:e=a==t&&l==t?globalThis.htmlBoard[0][0]:a==t?globalThis.htmlBoard[a][1+l]:globalThis.htmlBoard[1+a][l]}}e.focus()}});let shareEventListener;regenerateBtn.addEventListener("click",async e=>{e.target.disabled=!0;for(var t of loadingContainerSiblings)t.style.setProperty("visibility","hidden");loadingContainer.style.removeProperty("display"),clearTimer();var r,o=performance.now(),a=Number(difficultySlider.value)||rando(MIN_HOLES,MAX_HOLES);difficultySlider.value=a,difficultySlider.parentElement.querySelector("output").textContent=a,globalThis.debug&&globalThis.debugBoard?console.debug("Using debug board."):console.log(`Size: ${DEFAULT_BOARD_SIZE}, Holes: ${a}/${MAX_HOLES} (min: ${MIN_HOLES})`);let{fullBoard:l,board:n}=loadFromShareURL()??await generateSudoku(DEFAULT_BOARD_SIZE,a);globalThis.fullBoardNumberAmt=getNumberAmounts(l),displayBoard(n),checkErrors(),console.debug(`Took ${performance.now()-o}ms to generate and render.`),document.documentElement.style.setProperty("--sudoku-row-count",n.length),globalThis.screen.availWidth<1.2*Number.parseFloat(getComputedStyle(sudoku).width)&&document.documentElement.style.setProperty("font-size","unset"),shareButton.removeEventListener("click",shareEventListener),shareEventListener=async()=>{var e=generateShareURL(n,l);globalThis.history.pushState({},"",e),await globalThis.navigator.clipboard.writeText(e),alert("Saved link in your clipboard.")},shareButton.addEventListener("click",shareEventListener),loadingContainer.style.setProperty("display","none");for(r of loadingContainerSiblings)r.style.removeProperty("visibility");e.target.disabled=!1}),regenerateBtn.click();