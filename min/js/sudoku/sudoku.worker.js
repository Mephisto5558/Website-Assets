(globalThis.window=globalThis).importScripts("https://cdn.jsdelivr.net/gh/nastyox/Rando.js@master/code/plain-javascript/2.0.0/rando-min.js");let DEBUG_BOARDS={board:[[6,5,8,4,2,0,0,0,0],[0,2,3,7,0,0,4,0,0],[4,1,7,6,0,9,0,0,5],[0,0,6,8,0,5,7,4,2],[0,9,2,3,0,7,5,6,1],[7,4,5,1,6,2,9,0,8],[0,0,1,5,0,4,2,8,0],[0,7,0,9,8,0,0,5,0],[5,0,9,2,0,3,6,0,4]],fullBoard:[[6,5,8,4,2,1,3,9,7],[9,2,3,7,5,8,4,1,6],[4,1,7,6,3,9,8,2,5],[1,3,6,8,9,5,7,4,2],[8,9,2,3,4,7,5,6,1],[7,4,5,1,6,2,9,3,8],[3,6,1,5,7,4,2,8,9],[2,7,4,9,8,6,1,5,3],[5,8,9,2,1,3,6,7,4]]},THROTTLE_INTERVAL_MS=500;function getGroupId(e,r,t){return Math.floor(e/t)*t+Math.floor(r/t)}let lastProgressTimestamp;function sendProgress(e){var r=Date.now();if(!(r<=lastProgressTimestamp+THROTTLE_INTERVAL_MS))return lastProgressTimestamp=r,globalThis.postMessage({type:"progress",message:e})}function solver(i,{findJustOne:g=!0,useRandomSequence:u=!0}={}){let f=i.length,m=Math.sqrt(f),h=Array.from({length:f},()=>new Set),p=Array.from({length:f},()=>new Set),c=Array.from({length:f},()=>new Set);for(let r=0;r<f;r++)for(let e=0;e<f;e++){sendProgress(`Generating row ${r}, column `+e);var t=i[r][e];0!==t&&(h[r].add(t),p[e].add(t),c[getGroupId(r,e,m)].add(t))}var e=function e(r=0,t=0){if(r>=f)return 1;var[o,s]=t===f-1?[r+1,0]:[r,t+1];if(0!==i[r][t])return e(o,s);var n,a=getGroupId(r,t,m);let d=0;for(n of u?randoSequence(1,f):Array.from({length:f},(e,r)=>r+1))if(!(h[r].has(n)||p[t].has(n)||c[a].has(n))){i[r][t]=n,h[r].add(n),p[t].add(n),c[a].add(n);var l=e(o,s);if(g){if(0<l)return d+l}else if(1<(d+=l))return h[r].delete(n),p[t].delete(n),c[a].delete(n),i[r][t]=0,d;h[r].delete(n),p[t].delete(n),c[a].delete(n),i[r][t]=0}return d}();return g?0<e:e}function dig(e){var r,t=rando(0,e.length-1),o=rando(0,e.length-1);if(e[t][o])return r=e[t][o],e[t][o]=0,!(1<solver(structuredClone(e),{findJustOne:!1,useRandomSequence:!1})&&(e[t][o]=r,1))}function getEmptySudoku(e,r=0){return Array.from({length:e},()=>Array.from({length:e},()=>r))}function generateSudoku(e,r){if(globalThis.debugBoard)return DEBUG_BOARDS;var t=Math.sqrt(e);if(!Number.isInteger(t))throw new Error("Size must be quadratic.");sendProgress("Generating initial full Sudoku. Size: "+e);var t=performance.now(),o=getEmptySudoku(e);let s=solver(o,{findJustOne:!0,useRandomSequence:!0});if(!s)return globalThis.postMessage({type:"error",message:"Failed to generate a valid Sudoku board."}),{fullBoard:getEmptySudoku(e),board:getEmptySudoku(e)};globalThis.postMessage({type:"debug",message:`Took ${performance.now()-t}ms to generate.`});var n=structuredClone(o),a=e**2*3,d=e**2;sendProgress("Starting to dig holes. Holes to dig: "+r);let l=0,i=0,g=0;for(;l<r&&i<a&&g<d;i++){sendProgress(`Digging. Holes: ${l}/${r}, Attempts: ${i}/${a}, Consecutive attempts: ${g}/`+d);let e=dig(n);e?(g=0,l++):!1===e&&g++}return sendProgress(`Dug ${l}/${r} holes.`),{fullBoard:o,board:n}}globalThis.addEventListener("message",e=>{if(e.origin&&e.origin!==globalThis.origin)return console.warn(`Worker received a message from an untrusted origin: "${e.origin}". Ignoring.`);console.log("Worker: Task received from main thread.");var{size:e,holes:r,debugBoard:t}=e.data,t=(globalThis.debugBoard=t,generateSudoku(e,r));console.log("Worker: Task finished, posting result back."),globalThis.postMessage({type:"result",payload:t})});