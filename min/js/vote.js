(()=>{let e,t,r,n,o,i,a,l=!1,s=0,d=window.innerWidth,c={columnMode:"cards-column-mode",rowMode:"cards-row-mode"},u=document.querySelector("#header-container"),p=document.querySelector("#cards-container"),v=document.querySelector("#cards-container-pending"),m=y("input",{type:"text",placeholder:"Search",id:"search-box",value:new URLSearchParams(window.location.search).get("q"),className:"grey-hover",maxLength:200});m.addEventListener("input",({target:e})=>{e.value.length>e.maxLength&&(e.value=e.value.slice(0,e.maxLength)),clearTimeout(r),r=setTimeout(()=>{s=0,q(e.value)},500)});let h=(e,t,r=5e3)=>new Promise((n,o)=>{let i=setTimeout(()=>o(Error("Request timed out")),r);fetch(e?`/api/v1/internal/${e}`:void 0,t).then(n).catch(o).finally(()=>clearTimeout(i))}),f=async()=>new Map((await h(`vote/list?includePending=${!!e.dev}`).then(e=>e.json()))?.cards?.sort((e,t)=>(e.pending&&!t.pending?-1:e.pending-t.pending)||t.votes-e.votes||e.title.localeCompare(t.title)).map(e=>[e.id,e]));function y(e,t,r,n){let o=document.createElement(e);if(Object.keys(t??{}).length)for(let[i,a]of Object.entries(t))void 0!=a&&null!==a&&("object"==typeof a?Object.assign(o[i],a):o[i]=a);return r&&(n?r.replaceChildren(o):r.append(o)),o}function g(e,t){let r=new URL(window.location.href),n=new URLSearchParams(window.location.search);t?n.set(e,t):n.delete(e),r.search=n.toString(),window.history.pushState(void 0,void 0,r.toString())}async function b(t){let r=document.createDocumentFragment(),n=y("div",{id:"profile-container"});if(!(e=await h("user").catch(()=>{}).then(e=>e.json()))||e.errorCode)return 403==e.errorCode?y("h2",{textContent:e.error},document.body,!0):(r.append(m),y("button",{id:"feature-request-button",textContent:t?"New Request":"New Feature Request",className:"grey-hover"},r),y("button",{id:"login-button",textContent:t?"Login":"Login with Discord",className:"blue-button"},n).addEventListener("click",()=>window.location.href=`/auth/discord?redirectURL=${window.location.href}`),r.append(n),void u.append(r));let o=y("div",{id:"profile-container-wrapper"},n);n.addEventListener("click",()=>o.style.display="block"===o.style.display?"none":"block");let i=new Image(39,39);i.onload=()=>n.append(i),i.alt="Profile",i.src=`https://cdn.discordapp.com/avatars/${e.id}/${e.avatar}.webp?size=64`,y("div",{id:"username",textContent:e.displayName??e.username},o),y("button",{id:"logout-button",textContent:"Logout",className:"blue-button"},o).addEventListener("click",async()=>{let e=await fetch("/auth/logout");await Swal.fire(e.ok?{icon:"success",title:"Success",text:"You are now logged out."}:{icon:"error",title:"Logout failed",text:e.statusText}),e.ok&&window.location.reload()});let a=y("button",{id:"feature-request-button",textContent:t?"New Request":"New Feature Request",className:"grey-hover"});t?(y("br",r),r.append(n),r.append(m),r.append(a)):(r.append(m),r.append(a),r.append(n)),u.append(r)}function x(t){let r=document.querySelector("#feature-request-overlay");document.querySelector("#feature-request-button").addEventListener("click",()=>{if(!e?.id)return Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to create a feature request!"});u.inert=!0,p.inert=!0,v.inert=!0,i&&(i.inert=!0),r.style.display="block",t&&(p.style.display="none")});let n=document.querySelector("#feature-request-modal>button"),o=({key:e})=>{e&&"Escape"!==e||"none"===r.style.display||(u.inert="",p.inert="",v.inert="",i&&(i.inert=""),t&&(p.style.display=""),r.style.display="none")};n.addEventListener("click",o),document.addEventListener("keydown",o),e.dev&&document.querySelector("#feature-request-description").removeAttribute("required");let a=document.querySelector("#title-counter"),l=document.querySelector("#description-counter");document.querySelector("#feature-request-title").addEventListener("input",e=>{a.textContent=`${e.target.value.length}/140`,e.target.value.length>=140?a.classList.add("limit-reached"):a.classList.remove("limit-reached")}),document.querySelector("#feature-request-description").addEventListener("input",e=>{l.textContent=`${e.target.value.length}/4000`,e.target.value.length>=4e3?l.classList.add("limit-reached"):l.classList.remove("limit-reached")}),document.querySelector("#feature-request-modal").addEventListener("submit",e=>C(e,t))}function q(e=m.value,r=26){g("q",e=e?.toLowerCase());let n=(e?[...t.values()].filter(t=>t.title.toLowerCase().includes(e)||t.body.toLowerCase().includes(e)||t.id.toLowerCase().includes(e)):[...t.values()]).slice(s,r+s);if(!n.length&&!p.childElementCount&&!v.childElementCount)return void y("h2",{textContent:`There are currently no feature requests${e?" matching your search query":""} :(`},p,!0);for(let o of(s||(p.innerHTML="",v.innerHTML=""),n))w(o);if(s+=r,p.childElementCount+v.childElementCount<r&&t.size>s)return q(e,r)}function w(t){let r=y("div",{className:"card",id:t.id}),n=y("h2",{id:"title",textContent:t.title,contentEditable:String(!!e.dev)},r),o=t.body??e.dev?y("p",{id:"description",textContent:t.body,contentEditable:String(!!e.dev)},r):void 0,i=y("div",{className:"vote-buttons"},r),a=y("span",{className:"vote-counter",textContent:t.pending?"":t.votes??0});t.pending&&e.dev?y("button",{textContent:"Approve",className:"vote-button blue-button"},i).addEventListener("click",async()=>{let e=await h(`vote/approve?featureId=${t.id}`).then(e=>e.json());if(e.error)return Swal.fire({icon:"error",title:"Oops...",text:e.error});Swal.fire({icon:"success",title:"Success",text:"The feature request has been approved."}),p.append(r),v.childElementCount||(document.querySelector("#new-requests")?.remove(),document.querySelector("#old-requests")?.remove(),document.querySelector("#feature-request-overlay + *").style.marginTop=`${u.clientHeight+16}px`)}):t.pending||y("button",{className:"vote-button blue-button",textContent:"Upvote"},i).addEventListener("click",()=>$(t.id,a)),i.append(a);let l=y("button",{title:"Copy card Id",className:"manage-button grey-hover"},i),s=y("i",{className:"far fa-copy fa-xl"},l);if(l.addEventListener("click",()=>{navigator.clipboard.writeText(t.id),s.classList="fas fa-check fa-xl",setTimeout(()=>s.classList="far fa-copy fa-xl",3e3)}),e.dev&&(n.addEventListener("keydown",e=>{if(e.target.parentElement.parentElement.hasAttribute("modified")||e.target.parentElement.parentElement.setAttribute("modified",""),"Enter"!==e.key)return;e.preventDefault();let t=e.target.parentElement.nextElementSibling;t.firstChild.focus()}),o?.addEventListener("input",({target:e})=>{e.parentElement.hasAttribute("modified")||e.parentElement.setAttribute("modified","")})),e.dev||e.id==t.id.split("_")[0]){let d=y("button",{title:"Delete card",className:"manage-button grey-hover"},i);d.addEventListener("click",()=>Swal.fire({icon:"warning",title:"Are you sure?",text:"Are you sure you want to delete that card? This action cannot be undone!",showCancelButton:!0,preConfirm(){h(`vote/delete?featureId=${r.id}`).then(e=>e.statusText),r.remove(),v.childElementCount||(document.querySelector("#new-requests")?.remove(),document.querySelector("#old-requests")?.remove(),document.querySelector("#feature-request-overlay + *").style.marginTop=`${u.clientHeight+16}px`)}})),y("i",{className:"far fa-trash-can fa-xl"},d)}e.dev&&y("p",{id:"userId",title:"Click to copy",textContent:t.id.split("_")[0]},i).addEventListener("click",()=>navigator.clipboard.writeText(t.id.split("_")[0])),(t.pending?v:p).append(r),o?.value&&(o.style.height=`${o.scrollHeight}px`)}function L(){(l=!l)?(localStorage.setItem("displayMode","cardsInRows"),p.classList.remove(c.columnMode),v.classList.remove(c.columnMode),p.classList.add(c.rowMode),v.classList.add(c.rowMode)):(localStorage.setItem("displayMode","cardsInColumns"),p.classList.remove(c.rowMode),v.classList.remove(c.rowMode),p.classList.add(c.columnMode),v.classList.add(c.columnMode))}function E(e="dark"===o?"light":"dark"){if(o!==e){for(let t of(o=e,localStorage.setItem("theme",o),["bg","text","input-bg","input-focus-bg","card-bg","grey-text"]))document.documentElement.style.setProperty(`--${t}-color`,`var(--${o}-mode-${t}-color)`);if(a){let r=document.querySelectorAll("body, #header-container button, #header-container>#search-box, .card");for(let n of r)n.classList.add("color-transition");setTimeout(()=>{for(let e of r)e.classList.remove("color-transition")},300)}}}async function C(e,r){e.preventDefault();let n=await h("vote/new",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:e.target.title.value.trim(),description:e.target.description.value.trim()})}).then(e=>e.json());if(n.error)return void Swal.fire({icon:"error",title:"Oops...",text:n.error});await Swal.fire({icon:"success",title:"Success",text:`Your feature request has been submitted and ${n.approved?"approved":"will be reviewed shortly"}.`}),t.set(n.id,n),e.target.reset(),r&&(p.style.display=""),document.querySelector("#feature-request-overlay").style.display="none"}async function $(t,r){if(!e?.id)return void Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to vote!"});let n=await h(`vote/addvote?featureId=${t}`).then(e=>e.json());if(n.error)return void Swal.fire({icon:"error",title:"Oops...",text:n.error});Swal.fire({icon:"success",title:"Success",text:"Your vote has been successfully recorded."}),r.textContent=Number.parseInt(r.textContent)+1}async function S(){let e=[...document.querySelectorAll(".card[modified]")].reduce((e,r)=>{r.removeAttribute("modified");let n=t.get(r.id);return n&&(r.children.title.textContent.trim()!==n.title||r.children.description.textContent.trim()!=n.body)&&e.push({id:r.id,title:r.children.title.textContent.trim(),body:r.children.description.textContent.trim()}),e},[]);if(!e.length)return void Swal.fire({icon:"error",title:"Oops...",text:"No cards have been modified."});let r=await h("vote/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json());if(r.error)return void Swal.fire({icon:"error",title:"Oops...",text:r.error});Swal.fire({icon:"success",title:"Success",text:"The cards have been updated."}),s=0,t=await f(),q()}document.querySelector("#toggle-cards-display").addEventListener("click",()=>L()),document.querySelector("#toggle-color-scheme").addEventListener("click",()=>E()),window.addEventListener("scroll",()=>{t.size>s&&document.documentElement.scrollTop+document.documentElement.clientHeight>=document.documentElement.scrollHeight-15&&q()}),window.addEventListener("resize",()=>{clearTimeout(n),n=setTimeout(()=>{let e=window.innerWidth;d>769&&e<768||d<768&&e>769?window.location.reload():d=e},500)}),window.addEventListener("beforeunload",e=>{document.querySelectorAll(".card[modified]").length&&(e.returnValue="You have unsaved changes.")}),document.addEventListener("DOMContentLoaded",async()=>{E(localStorage.getItem("theme")??(window.matchMedia("(prefers-color-scheme: light)").matches&&"light")??"dark");let r=window.matchMedia("(max-width: 768px)").matches;r||(l="cardsInRows"===localStorage.getItem("displayMode")),await b(r),x(r),t=await f(),p.classList.add(l?c.rowMode:c.columnMode),v.classList.add(l?c.rowMode:c.columnMode),"#new"==window.location.hash&&document.querySelector("#feature-request-button").click(),navigator.clipboard??={writeText:e=>Swal.fire({icon:"error",title:"Copying is not available due to this page being served over HTTP.",text:`This was what you tried to copy: ${e}`})},q(),e.dev&&(v.childElementCount&&(document.body.insertBefore(y("h2",{id:"new-requests",textContent:"New Requests"}),v),document.body.insertBefore(y("h2",{id:"old-requests",textContent:"Approved Requests"}),p)),i=y("button",{id:"save-button",title:"Save",classList:"blue-button"},document.body),y("i",{classList:"fas fa-save fa-xl"},i),i.addEventListener("click",S)),document.querySelector("#feature-request-overlay + *").style.marginTop=`${u.clientHeight+16}px`,document.documentElement.style.scrollPaddingTop=`${u.clientHeight+20}px`,a=!0})})();