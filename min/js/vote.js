(()=>{let e,t,r,o,n=!1,i=!1,a=!1,s=0,d=window.innerWidth,l={columnMode:"cards-column-mode",rowMode:"cards-row-mode"},c=document.body.querySelector("#header-container"),u=document.body.querySelector("#cards-container"),p=document.body.querySelector("#cards-container-pending"),y=document.body.querySelector("#feature-request-overlay"),v=q("input",{type:"text",placeholder:"Search",id:"search-box",value:new URLSearchParams(globalThis.location.search).get("q"),className:"grey-hover",maxLength:200}),m=(e,t)=>{let r,o=(t,r,...o)=>{try{t(e(...o))}catch(n){r(n instanceof Error?n:Error(n))}};return(...e)=>new Promise((n,i)=>{clearTimeout(r),r=setTimeout(o.bind(void 0,n,i,...e),t)})},h=(e={})=>{e.key&&"Escape"!==e.key||"none"===y.style.display||(c.removeAttribute("inert"),u.removeAttribute("inert"),p.removeAttribute("inert"),r&&r.removeAttribute("inert"),a&&u.style.removeProperty("display"),y.style.removeProperty("display"))},f=m(async e=>{e.preventDefault();let r=e.target.parentElement;if(!r.title||!r.description)return;let o=await x("vote/new",{method:"POST",body:JSON.stringify({title:r.title.value.trim(),description:r.description.value.trim()})});try{o=await o.json()}catch{}if(!1===o.ok||o.error)return void Swal.fire({icon:"error",title:"Oops...",text:o.error??o.statusText});await Swal.fire({icon:"success",title:"Success",text:`Your feature request has been submitted and ${o.approved?"approved":"will be reviewed shortly"}.`}),t.set(o.id,o),h(),r.reset()},1e3),b=m(async(t,r)=>{if(!e?.id)return void Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to vote!"});let o=await x("vote/addvote",{method:"POST",body:JSON.stringify({featureId:t})});try{o=await o.json()}catch{}if(!1===o.ok||o.error)return void Swal.fire({icon:"error",title:"Oops...",text:o.error??o.statusText});Swal.fire({icon:"success",title:"Success",text:"Your vote has been successfully recorded."}),r.textContent=Number.parseInt(r.textContent)+1},1e3),g=m(async()=>{let e=[...document.body.querySelectorAll(".card[modified]")].reduce((e,r)=>{r.removeAttribute("modified");let o=t.get(r.id);return(o?.title&&r.children.title.textContent.trim()!==o.title||o.body&&r.children.description?.textContent.trim()!==o.body)&&e.push({id:r.id,title:r.children.title.textContent.trim(),body:r.children.description.textContent.trim()}),e},[]);if(!e.length)return void Swal.fire({icon:"error",title:"Oops...",text:"No cards have been modified."});let r=await x("vote/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});try{r=await r.json()}catch{}if(!1===r.ok||r.error)return void Swal.fire({icon:"error",title:"Oops...",text:r.error??r.statusText});Swal.fire({icon:"success",title:"Success",text:"The cards have been updated."}),s=0,t=await w(),C()},1e3);async function x(e,t={},r=5e3){void 0==t.body||t.headers||(t.headers={"Content-Type":"application/json"}),t.signal??=new AbortController().signal;let o=setTimeout(()=>t.signal.abort("Request timed out"),r),n=await fetch(e?`/api/v1/internal/${e}`:void 0,t);return clearTimeout(o),n}async function w(){return new Map((await x(`vote/list?includePending=${!!e.dev}`).then(e=>e.json()))?.cards?.sort((e,t)=>!e.pending&&t.pending?1:e.pending&&!t.pending?-1:(t.votes??0)-(e.votes??0)||e.title.localeCompare(t.title)).map(e=>[e.id,e]))}function q(e,t,r,o){let n=document.createElement(e);if(Object.keys(t??{}).length)for(let[i,a]of Object.entries(t))void 0!=a&&("object"==typeof a?Object.assign(n[i],a):n[i]=a);return r&&(o?r.replaceChildren(n):r.append(n)),n}function L(e,t){let r=new URL(globalThis.location.href),o=new URLSearchParams(globalThis.location.search);t?o.set(e,t):o.delete(e),r.search=o.toString(),globalThis.history.pushState(void 0,void 0,r.toString())}async function $(){let t=document.createDocumentFragment(),r=q("div",{id:"profile-container"});if(!(e=await x("user").then(e=>e.json()).catch(()=>{}))||e.errorCode)return e?.errorCode==403?q("h2",{textContent:e.error},document.body,!0):(t.append(v),q("button",{id:"feature-request-button",textContent:a?"New Request":"New Feature Request",className:"grey-hover"},t),q("button",{id:"login-button",textContent:a?"Login":"Login with Discord",className:"blue-button"},r).addEventListener("click",()=>globalThis.location.href=`/auth/discord?redirectURL=${globalThis.location.href}`),t.append(r),c.append(t));let o=q("div",{id:"profile-container-wrapper"},r);r.addEventListener("click",()=>o.style.display="block"===o.style.display?"none":"block");let n=new Image(39,39);n.onload=()=>r.append(n),n.alt="Profile",n.src=`https://cdn.discordapp.com/avatars/${e.id}/${e.avatar}.webp?size=64`,q("div",{id:"username",textContent:e.displayName??e.username},o),q("button",{id:"logout-button",textContent:"Logout",className:"blue-button"},o).addEventListener("click",async()=>{let e=await fetch("/auth/logout");await Swal.fire(e.ok?{icon:"success",title:"Success",text:"You are now logged out."}:{icon:"error",title:"Logout failed",text:e.statusText}),e.ok&&globalThis.location.reload()});let i=q("button",{id:"feature-request-button",textContent:a?"New Request":"New Feature Request",className:"grey-hover"});a?(q("br",t),t.append(r),t.append(v),t.append(i)):(t.append(v),t.append(i),t.append(r)),c.append(t)}function E(){let t=y.querySelector("#feature-request-modal");t.querySelector("#feature-request-submit-button").addEventListener("click",f),c.querySelector("#feature-request-button").addEventListener("click",()=>{if(!e?.id)return Swal.fire({icon:"error",title:"Who are you?",text:"You must be logged in to be able to create a feature request!"});c.inert=!0,u.inert=!0,p.inert=!0,r&&(r.inert=!0),y.style.display="block",a&&(u.style.display="none")}),t.querySelector("#feature-request-reset-btn").addEventListener("click",h),document.addEventListener("keydown",h),e.dev&&t.querySelector("#feature-request-description").removeAttribute("required");let o=t.querySelector("#title-counter"),n=t.querySelector("#description-counter");t.querySelector("#feature-request-title").addEventListener("input",e=>{o.textContent=`${e.target.value.length}/140`,e.target.value.length>=140?o.classList.add("limit-reached"):o.classList.remove("limit-reached")}),t.querySelector("#feature-request-description").addEventListener("input",e=>{n.textContent=`${e.target.value.length}/4000`,e.target.value.length>=4e3?n.classList.add("limit-reached"):n.classList.remove("limit-reached")})}function C(e=v.value,r=26){L("q",e=e.toLowerCase());let o=e?[...t.values()].filter(t=>t.title.toLowerCase().includes(e)||t.body.toLowerCase().includes(e)||t.id.toLowerCase().includes(e)):[...t.values()];if(!o.length&&!u.childElementCount&&!p.childElementCount)return void q("h2",{textContent:`There are currently no feature requests${e?" matching your search query":""} :(`},u,!0);for(let n of(s||(u.innerHTML="",p.innerHTML=""),o.slice(s,r+s)))S(n);return s+=r,t.size>s&&(u.childElementCount+p.childElementCount<r?C(e,r):u.clientHeight<window.innerHeight&&C(e,Math.ceil((window.innerHeight-u.clientHeight)/(u.clientHeight/u.childElementCount)))),o}function S(t){let r=q("div",{className:"card",id:t.id}),o=q("h2",{id:"title",textContent:t.title,contentEditable:String(!!e.dev)},r),n=t.body||e.dev?q("p",{id:"description",textContent:t.body,contentEditable:String(!!e.dev)},r):void 0,i=q("div",{className:"vote-buttons"},r),a=q("span",{className:"vote-counter",textContent:t.pending?"":t.votes??0});t.pending&&e.dev?q("button",{textContent:"Approve",className:"vote-button blue-button"},i).addEventListener("click",async()=>{let e=await x("vote/approve",{method:"POST",body:JSON.stringify({featureId:t.id})});try{e=await e.json()}catch{}if(!1===e.ok||e.error)return void Swal.fire({icon:"error",title:"Oops...",text:e.error??e.statusText});Swal.fire({icon:"success",title:"Success",text:"The feature request has been approved."}),u.append(r),p.childElementCount||(document.body.querySelector("#new-requests")?.remove(),document.body.querySelector("#old-requests")?.remove(),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${c.clientHeight+16}px`)}):t.pending||q("button",{className:"vote-button blue-button",textContent:"Upvote"},i).addEventListener("click",()=>b(t.id,a)),i.append(a);let s=q("button",{title:"Copy card Id",className:"manage-button grey-hover"},i),d=q("i",{className:"far fa-copy fa-xl"},s);if(s.addEventListener("click",()=>{navigator.clipboard.writeText(t.id),d.classList="fas fa-check fa-xl",setTimeout(()=>d.classList="far fa-copy fa-xl",3e3)}),e.dev&&(o.addEventListener("keydown",e=>{if(e.target.parentElement.hasAttribute("modified")||e.target.parentElement.setAttribute("modified",""),"Enter"!==e.key)return;e.preventDefault();let t=e.target.nextElementSibling;t.firstChild.focus()}),n?.addEventListener("input",({target:e})=>{e.parentElement.hasAttribute("modified")||e.parentElement.setAttribute("modified","")})),e.dev||e.id==t.id.split("_")[0]){let l=q("button",{title:"Delete card",className:"manage-button grey-hover"},i);l.addEventListener("click",()=>Swal.fire({icon:"warning",title:"Are you sure?",text:"Are you sure you want to delete that card? This action cannot be undone!",showCancelButton:!0,async preConfirm(){await x("vote/delete",{method:"DELETE",body:JSON.stringify({featureId:t.id})}),r.remove(),p.childElementCount||(document.body.querySelector("#new-requests")?.remove(),document.body.querySelector("#old-requests")?.remove(),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${c.clientHeight+16}px`)}})),q("i",{className:"far fa-trash-can fa-xl"},l)}e.dev&&q("p",{id:"userId",title:"Click to copy",textContent:t.id.split("_")[0]},i).addEventListener("click",()=>navigator.clipboard.writeText(t.id.split("_")[0])),(t.pending?p:u).append(r),n?.value&&(n.style.height=`${n.scrollHeight}px`)}function k(){(i=!i)?(localStorage.setItem("displayMode","cardsInRows"),u.classList.remove(l.columnMode),p.classList.remove(l.columnMode),u.classList.add(l.rowMode),p.classList.add(l.rowMode)):(localStorage.setItem("displayMode","cardsInColumns"),u.classList.remove(l.rowMode),p.classList.remove(l.rowMode),u.classList.add(l.columnMode),p.classList.add(l.columnMode))}function T(e="dark"===o?"light":"dark"){if(o!==e){for(let t of(o=e,localStorage.setItem("theme",o),["bg","text","input-bg","input-focus-bg","card-bg","grey-text"]))document.documentElement.style.setProperty(`--${t}-color`,`var(--${o}-mode-${t}-color)`);if(n){let r=document.querySelectorAll("body, #header-container button, #header-container>#search-box, .card");for(let i of r)i.classList.add("color-transition");setTimeout(()=>{for(let e of r)e.classList.remove("color-transition")},300)}}}function M(e){e.target?.isContentEditable&&(e.preventDefault(),document.execCommand("insertText",!1,e.clipboardData.getData("text/plain")))}v.addEventListener("input",m(({target:t})=>{t.value.length>t.maxLength&&(t.value=t.value.slice(0,t.maxLength)),s=0;let r=C(t.value);document.querySelector("#feature-request-count>span").textContent=(e.dev?r:r.filter(e=>!e.pending)).length},500)),c.querySelector("#toggle-cards-display").addEventListener("click",()=>k()),c.querySelector("#toggle-color-scheme").addEventListener("click",()=>T()),window.addEventListener("scroll",()=>{t.size>s&&document.documentElement.scrollTop+document.documentElement.clientHeight>=document.documentElement.scrollHeight-16&&C()}),window.addEventListener("resize",m(()=>{let e=window.innerWidth;d>=768&&e<768||d<768&&e>=768?globalThis.location.reload():d=e},500)),window.addEventListener("beforeunload",e=>{document.body.querySelectorAll(".card[modified]").length&&e.preventDefault()}),document.addEventListener("DOMContentLoaded",async()=>{T(localStorage.getItem("theme")??(globalThis.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark")),(a=globalThis.matchMedia("(max-width: 768px)").matches)||(i="cardsInRows"===localStorage.getItem("displayMode")),await $(),E(),t=await w(),u.classList.add(i?l.rowMode:l.columnMode),p.classList.add(i?l.rowMode:l.columnMode),document.querySelector("#feature-request-count > span").textContent=e.dev?t.size:[...t.values()].filter(e=>!e.pending).length,"#new"==globalThis.location.hash&&c.querySelector("#feature-request-button").click(),navigator.clipboard??={writeText:e=>Swal.fire({icon:"error",title:"Copying is not available due to this page being served over HTTP.",text:`This was what you tried to copy: ${e}`})},C(),e.dev&&(u.addEventListener("paste",M),p.childElementCount&&(document.body.insertBefore(q("h2",{id:"new-requests",textContent:"New Requests"}),p),document.body.insertBefore(q("h2",{id:"old-requests",textContent:"Approved Requests"}),u),p.addEventListener("paste",M)),r=q("button",{id:"save-button",title:"Save",classList:"blue-button"},document.body),q("i",{classList:"fas fa-save fa-xl"},r),r.addEventListener("click",g)),document.body.querySelector("#feature-request-overlay + *").style.marginTop=`${c.clientHeight+16}px`,document.documentElement.style.scrollPaddingTop=`${c.clientHeight+20}px`,n=!0})})();